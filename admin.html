<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Stellar Tree Management</title>
    <link rel="icon" type="image/x-icon" href="images/logo.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="admin-config.js"></script>
    <style>
        /* Admin Panel Theme - Matching Stellar Tree Management */
        :root {
            --admin-primary: #2a2a2a;
            --admin-accent: #8cc63f;
            --admin-secondary: #5a5a5a;
            --admin-bg: #f8f9fa;
            --admin-text: #2a2a2a;
            --admin-light-gray: #f8fafc;
            --admin-border: #e5e7eb;
            --admin-success: #28a745;
            --admin-warning: #ffc107;
            --admin-danger: #dc3545;
            --admin-info: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, var(--admin-bg) 0%, #ffffff 100%);
            color: var(--admin-text);
            font-family: 'Inter', sans-serif;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 120px 2rem 60px;
            overflow-x: hidden;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }
        
        .admin-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--admin-primary);
        }
        
        .admin-header p {
            font-size: 1.1rem;
            color: var(--admin-secondary);
            margin-bottom: 1rem;
        }

        .logout-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--admin-danger);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--admin-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--admin-accent);
            margin-bottom: 0.5rem;
        }
        
        .stat-card p {
            color: var(--admin-primary);
            font-weight: 500;
        }

        .stat-card.pending h3 { color: var(--admin-warning); }
        .stat-card.confirmed h3 { color: var(--admin-success); }
        .stat-card.completed h3 { color: var(--admin-info); }
        .stat-card.cancelled h3 { color: var(--admin-danger); }
        
        .bookings-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .active-bookings-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
            overflow-y: auto;
        }

        .history-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--admin-light-gray);
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--admin-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header h2 i {
            color: var(--admin-accent);
        }
        
        .refresh-btn {
            background: var(--admin-accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .refresh-btn:hover {
            background: #7ab33a;
            transform: translateY(-1px);
        }

        /* Slim and Sleek Tab Navigation System */
        .filter-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--admin-border);
        }

        .tab-category {
            margin-bottom: 0.5rem;
        }

        .tab-category:last-child {
            margin-bottom: 0;
        }

        .tab-category-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--admin-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            padding-left: 0.25rem;
        }

        .tab-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--admin-light-gray);
            border: 1px solid var(--admin-border);
            color: var(--admin-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            min-width: 120px;
            justify-content: center;
        }

        .filter-tab i {
            font-size: 0.9rem;
            transition: transform 0.2s ease;
        }

        .filter-tab:hover {
            background: #e9ecef;
            border-color: var(--admin-accent);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .filter-tab:hover i {
            transform: scale(1.05);
        }

        .filter-tab.active {
            background: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
            box-shadow: 0 2px 8px rgba(140, 198, 63, 0.3);
        }

        .filter-tab.active i {
            transform: scale(1.05);
        }

        /* Loading state for tabs */
        .filter-tab.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .filter-tab.loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Smooth transitions for view changes */
        #activeBookingsGrid,
        #calendarView,
        #customerView {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 1;
            transform: translateY(0);
            position: relative;
        }

        #sectionTitle {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Hide views smoothly */
        .view-hidden {
            opacity: 0 !important;
            transform: translateY(10px) !important;
            pointer-events: none;
        }

        /* Ensure proper initial states */
        #activeBookingsGrid,
        #calendarView,
        #customerView {
            will-change: opacity, transform;
            backface-visibility: hidden;
            transform-style: preserve-3d;
        }

        /* Prevent layout shifts during transitions */
        .active-bookings-section {
            min-height: 400px;
            position: relative;
        }

        /* Responsive Design for Tabs */
        @media (max-width: 768px) {
            .filter-tabs {
                padding: 0.75rem;
            }
            
            .tab-row {
                gap: 0.4rem;
            }
            
            .filter-tab {
                min-width: 100px;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .filter-tab i {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .filter-tabs {
                padding: 0.5rem;
            }
            
            .tab-category-title {
                font-size: 0.65rem;
            }
            
            .filter-tab {
                min-width: 80px;
                padding: 0.35rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .filter-tab i {
                font-size: 0.75rem;
            }
        }
        
        .bookings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .booking-card {
            background: white;
            border-radius: 8px;
            padding: 0.6rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: all 0.15s ease;
            cursor: pointer;
            position: relative;
        }

        .booking-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }

        .booking-card.completed {
            border-left: 3px solid #17a2b8;
        }

        .booking-card.cancelled {
            border-left: 3px solid #dc3545;
        }

        .booking-card.pending {
            border-left: 3px solid #ffc107;
        }

        .booking-card.confirmed {
            border-left: 3px solid #28a745;
        }



        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .booking-id {
            font-size: 0.75rem;
            font-weight: 600;
            color: #495057;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 0.15rem 0.6rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            position: relative;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .status-badge::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
            z-index: -1;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .status-badge.status-pending {
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .status-badge.status-confirmed {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
        }

        .status-badge.status-completed {
            color: #17a2b8;
            background: rgba(23, 162, 184, 0.1);
            border-color: rgba(23, 162, 184, 0.3);
        }

        .status-badge.status-cancelled {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
        }

        .booking-essentials {
            margin-bottom: 0.4rem;
        }

        .essential-row {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.2rem;
            font-size: 0.75rem;
        }

        .essential-row:last-child {
            margin-bottom: 0;
        }

        .essential-icon {
            width: 12px;
            color: #6c757d;
            font-size: 0.7rem;
        }

        .essential-label {
            font-weight: 500;
            color: #6c757d;
            min-width: 45px;
            font-size: 0.7rem;
        }

        .essential-value {
            color: #212529;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .booking-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            padding: 0.15rem 0.4rem;
            font-size: 0.6rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.1rem;
            min-height: 22px;
            min-width: 22px;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .action-btn:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .action-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn.confirm {
            background: #28a745;
            color: white;
        }

        .action-btn.complete {
            background: #17a2b8;
            color: white;
        }

        .action-btn.warning {
            background: #fd7e14;
            color: white;
        }

        .action-btn.cancel {
            background: #ffc107;
            color: #212529;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn.move {
            background: #6f42c1;
            color: white;
        }

        .action-btn.quote {
            background: #8cc63f;
            color: white;
        }

        /* Booking Images */
        .booking-images {
            margin-top: 0.5rem;
        }

        .images-preview {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .booking-image-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .booking-image-thumbnail:hover {
            transform: scale(1.1);
        }

        .more-images {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .image-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Booking Images in Detail Popup */
        .booking-images-detail {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .booking-image-detail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .booking-image-detail:hover {
            transform: scale(1.05);
            border-color: var(--admin-accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Compact Calendar Popup */
        .calendar-popup-compact {
            max-width: 350px;
            width: 100%;
            max-height: 60vh;
            overflow-y: auto;
            margin: 0;
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .calendar-popup-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-popup-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .calendar-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .calendar-popup-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .calendar-popup-content {
            padding: 1rem;
        }

        .calendar-booking-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #8cc63f;
        }

        .calendar-booking-preview:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-booking-preview h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
            color: #333;
        }

        .calendar-booking-preview p {
            margin: 0;
            font-size: 0.8rem;
            color: #666;
        }

        .calendar-popup-actions {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
        }

        .calendar-popup-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-popup-btn.primary {
            background: #8cc63f;
            color: white;
        }

        .calendar-popup-btn.primary:hover {
            background: #7ab32e;
        }

        .calendar-popup-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .calendar-popup-btn.secondary:hover {
            background: #5a6268;
        }

        /* Booking Details Popup Modal */
        .booking-details-popup {
            max-width: 450px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            margin: 10px;
            position: relative;
            padding: 20px;
            display: block;
        }

        .detail-popup-grid {
            display: grid;
            gap: 0.75rem;
        }

        .detail-popup-section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid var(--primary-color);
        }

        .detail-popup-section h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
        }

        .detail-popup-section h4 i {
            color: var(--primary-color);
            font-size: 0.8rem;
        }

        .detail-popup-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .detail-popup-row:last-child {
            border-bottom: none;
        }

        .detail-popup-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.8rem;
        }

        .detail-popup-value {
            color: #212529;
            font-weight: 500;
            text-align: right;
            max-width: 65%;
            font-size: 0.85rem;
        }

        .detail-popup-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .detail-popup-actions .action-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Admin Container */
            .admin-container {
                padding: 100px 1rem 40px;
                max-width: 100%;
            }

            /* Header */
            .admin-header {
                margin-bottom: 2rem;
                text-align: center;
            }

            .admin-header h1 {
                font-size: 1.8rem;
                margin-bottom: 0.5rem;
            }

            .admin-header p {
                font-size: 1rem;
                margin-bottom: 1rem;
            }

            .logout-btn {
                position: static;
                margin-top: 1rem;
                width: 100%;
                justify-content: center;
                padding: 0.75rem 1rem;
            }

            /* Statistics Grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 2rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .stat-card p {
                font-size: 0.9rem;
            }

            /* Main Content Layout */
            .bookings-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .active-bookings-section,
            .history-section {
                padding: 1.5rem;
                border-radius: 16px;
            }

            /* Section Headers */
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
                margin-bottom: 1.5rem;
            }

            .section-header h2 {
                font-size: 1.3rem;
            }

            .refresh-btn {
                width: 100%;
                justify-content: center;
                padding: 0.75rem 1rem;
            }

            /* Filter Tabs */
            .filter-tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .filter-tab {
                flex: 1;
                min-width: 80px;
                text-align: center;
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            /* Bookings Grid */
            .bookings-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .booking-card {
                padding: 1rem;
                border-radius: 12px;
            }

            .booking-header {
                margin-bottom: 0.75rem;
            }

            .booking-id {
                font-size: 0.8rem;
            }

            .status-badge {
                padding: 0.25rem 0.75rem;
                font-size: 0.7rem;
            }

            .booking-essentials {
                margin-bottom: 0.75rem;
            }

            .essential-row {
                margin-bottom: 0.4rem;
                font-size: 0.85rem;
                align-items: flex-start;
            }

            .essential-label {
                min-width: 60px;
                font-size: 0.8rem;
            }

            .essential-value {
                font-size: 0.85rem;
                flex: 1;
            }

            /* Action Buttons */
            .booking-actions {
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .action-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-height: 36px;
                min-width: 36px;
                border-radius: 8px;
                flex: 1;
                min-width: 80px;
                justify-content: center;
            }

            /* Calendar View - Mobile Optimized */
            .calendar-view {
                padding: 1rem;
                overflow: visible;
            }

            .calendar-controls {
                flex-direction: column;
                gap: 1rem;
                align-items: center;
                margin-bottom: 1rem;
            }

            .calendar-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 1rem;
                min-width: 44px;
                min-height: 44px;
            }

            #calendarMonth {
                font-size: 1.2rem;
                font-weight: 600;
                text-align: center;
            }

            /* Mobile Calendar Grid - Vertical Layout */
            .calendar-grid {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            /* Week Headers */
            .calendar-week-header {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 0.25rem;
                margin-bottom: 0.5rem;
            }

            .calendar-week-header .day-header {
                font-size: 0.7rem;
                font-weight: 600;
                padding: 0.5rem 0.25rem;
                text-align: center;
                background: var(--admin-light-gray);
                border-radius: 4px;
                color: var(--admin-primary);
            }

            /* Week Rows */
            .calendar-week {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 0.25rem;
                margin-bottom: 0.5rem;
            }

            .calendar-week .day {
                aspect-ratio: 1;
                min-height: 50px;
                font-size: 0.85rem;
                position: relative;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 0.25rem;
                border: 1px solid var(--admin-border);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                font-weight: 600;
                color: var(--admin-secondary);
            }

            .calendar-week .day:hover:not(.today, .booked, .blocked, .weekend) {
                background: var(--admin-light-gray);
            }

            .calendar-week .day.today {
                background: var(--admin-accent);
                color: white;
                border-color: var(--admin-accent);
            }

            .calendar-week .day.booked {
                background: rgba(23, 162, 184, 0.1);
                border-color: rgba(23, 162, 184, 0.3);
                color: var(--admin-info);
            }

            .calendar-week .day.blocked {
                background: rgba(220, 53, 69, 0.1);
                border-color: rgba(220, 53, 69, 0.3);
                color: var(--admin-danger);
            }

            .calendar-week .day.weekend {
                background: var(--admin-light-gray);
                color: var(--admin-primary);
            }

            .calendar-week .day.available {
                background: rgba(40, 167, 69, 0.1);
                border-color: rgba(40, 167, 69, 0.3);
                color: var(--admin-success);
            }

            /* Booking Info for Mobile */
            .booking-info {
                position: absolute;
                bottom: 1px;
                left: 1px;
                right: 1px;
                background: rgba(23, 162, 184, 0.9);
                color: white;
                border-radius: 3px;
                padding: 1px 2px;
                font-size: 0.5rem;
                text-align: center;
                max-width: calc(100% - 2px);
            }

            .booking-count {
                font-weight: bold;
                font-size: 0.6rem;
            }

            .booking-preview {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 0.5rem;
            }

            .calendar-legend {
                flex-wrap: wrap;
                gap: 0.75rem;
                justify-content: center;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid var(--admin-light-gray);
            }

            .legend-item {
                font-size: 0.75rem;
                display: flex;
                align-items: center;
                gap: 0.4rem;
            }

            .legend-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            /* History Section */
            .history-section {
                max-height: 400px;
            }

            .history-item {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .history-item h4 {
                font-size: 0.9rem;
            }

            .history-item p {
                font-size: 0.8rem;
            }

            /* Modals */
            .modal-content {
                width: 95%;
                max-width: 450px;
                margin: 10px;
                padding: 1rem;
            }

            .modal-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .modal-header h3 {
                font-size: 1.2rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }

            /* Login Form */
            .login-form .form-group {
                margin-bottom: 1.5rem;
            }

            .login-form label {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .login-form input {
                padding: 1rem;
                font-size: 1rem;
            }

            /* Booking Details Popup */
            .booking-details-popup {
                width: 95%;
                max-width: 450px;
                max-height: 90vh;
                overflow-y: auto;
                padding: 1rem;
            }

            .calendar-popup-compact {
                width: 100%;
                max-width: 400px;
                max-height: 85vh;
                margin: 0 auto;
            }

            .detail-popup-section {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }

            .detail-popup-section:last-child {
                margin-bottom: 0;
            }

            .detail-popup-section h4 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .detail-popup-row {
                padding: 0.5rem 0;
                font-size: 0.9rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }

            .detail-popup-label {
                font-size: 0.8rem;
                font-weight: 600;
            }

            .detail-popup-value {
                font-size: 0.9rem;
                max-width: 100%;
                text-align: left;
            }

            .detail-popup-actions {
                gap: 0.5rem;
                margin-top: 1rem;
                flex-wrap: wrap;
                justify-content: flex-start;
            }

            .detail-popup-actions .action-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
                flex: 1;
                min-width: 120px;
                max-width: 200px;
            }

            /* Move Booking Modal */
            .move-booking-modal {
                width: 95%;
                max-width: 450px;
                max-height: 90vh;
            }

            .info-card {
                padding: 0.75rem;
            }

            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                padding: 0.75rem;
            }

            .info-item i {
                margin-bottom: 0.25rem;
            }

            .move-calendar-nav {
                padding: 0.75rem;
            }

            .nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .move-calendar-grid .day {
                min-height: 40px;
                font-size: 0.9rem;
            }

            .move-calendar-grid .day-header {
                font-size: 0.8rem;
                padding: 0.5rem 0.25rem;
            }

            /* Notifications */
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-100px);
            }

            .notification.show {
                transform: translateY(0);
            }

            .notes-textarea {
                width: 100%;
                min-height: 60px;
                padding: 0.4rem;
                border: 1px solid var(--admin-border);
                border-radius: 4px;
                font-family: 'Inter', sans-serif;
                font-size: 0.75rem;
                resize: vertical;
                background: white;
            }

            .notes-textarea:focus {
                outline: none;
                border-color: var(--admin-accent);
                box-shadow: 0 0 0 2px rgba(140, 198, 63, 0.1);
            }
        }

        @media (max-height: 600px) {
            .booking-details-popup {
                max-height: 98vh;
                margin: 5px;
                padding: 0.75rem;
            }

            .detail-popup-grid {
                gap: 0.5rem;
            }

            .detail-popup-section {
                padding: 0.5rem;
                margin-bottom: 0.25rem;
            }

            .detail-popup-section h4 {
                margin-bottom: 0.3rem;
            }

            .detail-popup-row {
                padding: 0.25rem 0;
            }

            .detail-popup-actions {
                margin-top: 0.75rem;
                gap: 0.4rem;
            }

            .detail-popup-actions .action-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                min-height: 36px;
                min-width: 100px;
            }
        }

        .empty-state {
            text-align: center;
            color: var(--admin-secondary);
            font-style: italic;
            padding: 2rem;
            grid-column: 1 / -1;
        }

        .history-item {
            background: var(--admin-light-gray);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--admin-accent);
        }

        .history-item.completed {
            border-left-color: var(--admin-success);
        }

        .history-item.cancelled {
            border-left-color: var(--admin-danger);
        }

        .history-item h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--admin-primary);
        }

        .history-item p {
            font-size: 0.8rem;
            color: var(--admin-secondary);
            margin: 0.25rem 0;
        }

        .history-item .history-date {
            font-size: 0.7rem;
            color: var(--admin-secondary);
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--admin-primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 300px;
            color: #333;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--admin-success);
        }

        .notification.error {
            border-left: 4px solid var(--admin-danger);
        }

        /* Calendar booking info styles */
        .booking-info {
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            background: rgba(23, 162, 184, 0.9);
            color: white;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.7rem;
            text-align: center;
        }

        .booking-count {
            font-weight: bold;
            font-size: 0.8rem;
        }

        .booking-preview {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Move booking modal styles */
        .move-booking-info {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--admin-light-gray);
            border-radius: 8px;
        }

        .move-booking-info p {
            margin: 0.5rem 0;
            color: #333;
        }

        .move-date-selection {
            margin-bottom: 1rem;
        }

        .move-date-selection label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
        }

        .date-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--admin-border);
            border-radius: 8px;
            font-size: 1rem;
            color: #333;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--admin-accent);
        }

        .move-actions {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .notification.info {
            border-left: 4px solid var(--admin-info);
        }

        /* Login Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--admin-border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            padding: 20px;
            margin: 0;
        }

        /* Special styling for calendar popup modal content */
        #bookingDetailsModal .modal-content {
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Ensure booking details popup modal has proper scrolling */
        #bookingDetailsPopupModal .modal-content {
            overflow-y: auto;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }

        #bookingDetailsPopupModal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--admin-border);
            position: relative;
            padding-right: 3rem;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-body {
            padding: 1.5rem;
            color: #333;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--admin-border);
            justify-content: flex-end;
        }

        .login-form .form-group {
            margin-bottom: 1rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--admin-primary);
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--admin-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--admin-accent);
        }

        .btn-primary {
            background: var(--admin-accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #7ab33a;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--admin-light-gray);
            color: #333;
            border: 1px solid var(--admin-border);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #000;
        }

        .error-message {
            color: var(--admin-danger);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Calendar Styles */
        .calendar-view {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
            overflow-y: auto;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--admin-light-gray);
        }

        .calendar-nav-btn {
            background: var(--admin-light-gray);
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:hover {
            background: #e9ecef;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: hidden;
            overflow-y: visible;
            width: 100%;
        }

        .calendar-grid .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: var(--admin-secondary);
            position: relative;
            min-height: 80px;
        }

        .calendar-grid .day:hover:not(.today, .booked, .blocked, .weekend) {
            background: var(--admin-light-gray);
        }

        .calendar-grid .day.today {
            background: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
        }

        .calendar-grid .day.booked {
            background: rgba(23, 162, 184, 0.1);
            border-color: rgba(23, 162, 184, 0.3);
            color: var(--admin-info);
        }

        .calendar-grid .day.blocked {
            background: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
            color: var(--admin-danger);
        }

        .calendar-grid .day.weekend {
            background: var(--admin-light-gray);
            color: var(--admin-primary);
        }

        .calendar-grid .day.available {
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
            color: var(--admin-success);
        }

        .calendar-grid .day.booked:hover {
            background: rgba(23, 162, 184, 0.2);
            border-color: rgba(23, 162, 184, 0.4);
        }

        .calendar-grid .day.blocked:hover {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.4);
        }

        .calendar-grid .day.weekend:hover {
            background: #e9ecef;
        }

        .calendar-grid .day.today:hover {
            background: #5a5a5a;
            color: white;
        }

        /* Drag and Drop Styles */
        .calendar-grid .day.drag-over {
            background: rgba(23, 162, 184, 0.3) !important;
            border: 2px dashed var(--admin-info) !important;
        }

        .booking-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .drag-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--admin-info);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Hide drag indicator for non-calendar tabs */
        .booking-card .drag-indicator {
            display: none;
        }

        .calendar-legend {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--admin-light-gray);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .legend-indicator.available {
            background: var(--admin-success);
        }

        .legend-indicator.booked {
            background: var(--admin-info);
        }

        .legend-indicator.blocked {
            background: var(--admin-danger);
        }

        .legend-indicator.weekend {
            background: var(--admin-primary);
        }

        /* Booking Details Modal Styles */
        .booking-detail-item {
            background: var(--admin-light-gray);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--admin-accent);
        }

        .booking-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .booking-detail-header h4 {
            margin: 0;
            color: var(--admin-primary);
            font-size: 1.1rem;
        }

        .booking-detail-info {
            margin-bottom: 1rem;
        }

        .booking-detail-info p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .booking-detail-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .date-info {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--admin-light-gray);
            border-radius: 8px;
        }

        .date-info p {
            margin: 0.5rem 0;
            font-size: 1rem;
        }

        .blocking-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #333;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #000;
        }

        /* Move Booking Modal Styles */
        .move-booking-modal {
            max-width: 550px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .move-booking-info {
            margin-bottom: 1.5rem;
        }

        .info-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-item i {
            font-size: 1.2rem;
            color: var(--primary-color);
            width: 24px;
            text-align: center;
        }

        .info-item div {
            flex: 1;
        }

        .info-item label {
            display: block;
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .info-item span {
            display: block;
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .move-date-selection h4 {
            margin-bottom: 0.75rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .move-date-selection h4 i {
            color: var(--primary-color);
        }

        .move-calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            color: #333;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        #moveCalendarMonth {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .move-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 0.75rem;
        }

        .move-calendar-grid .day-header {
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            padding: 0.25rem;
            font-size: 0.8rem;
        }

        .move-calendar-grid .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            min-height: 32px;
        }

        .move-calendar-grid .day:hover:not(.disabled):not(.booked):not(.blocked) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .move-calendar-grid .day.selected {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .move-calendar-grid .day.disabled {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
        }

        .move-calendar-grid .day.booked {
            background: #dc3545;
            color: white;
            cursor: not-allowed;
        }

        .move-calendar-grid .day.blocked {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
        }

        .move-calendar-grid .day.available {
            background: #28a745;
            color: white;
        }

        .move-calendar-grid .day.other-month {
            color: #adb5bd;
            background: #f8f9fa;
        }

        .selected-date-display {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .selected-date-display i {
            color: #28a745;
            font-size: 1.2rem;
        }

        .selected-date-display span {
            color: #155724;
            font-weight: 500;
        }

        .move-actions {
            text-align: center;
            margin-top: 1rem;
        }

        .move-actions .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Responsive adjustments for move booking modal */
        @media (max-height: 700px) {
            .move-booking-modal {
                max-height: 95vh;
            }
            
            .move-booking-info {
                margin-bottom: 1rem;
            }
            
            .info-card {
                padding: 0.75rem;
            }
            
            .info-item {
                margin-bottom: 0.5rem;
                padding: 0.4rem;
            }
            
            .move-calendar-grid .day {
                min-height: 28px;
                font-size: 0.75rem;
            }
            
            .move-calendar-grid .day-header {
                font-size: 0.7rem;
                padding: 0.2rem;
            }
        }

        @media (max-width: 480px) {
            .move-booking-modal {
                width: 98%;
                max-width: 400px;
            }
            
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .info-item i {
                margin-bottom: 0.25rem;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            .admin-container {
                padding: 90px 0.5rem 30px;
            }

            .admin-header h1 {
                font-size: 1.5rem;
            }

            .admin-header p {
                font-size: 0.9rem;
            }

            /* Statistics */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .stat-card h3 {
                font-size: 1.3rem;
            }

            /* Filter Tabs */
            .filter-tabs {
                flex-direction: column;
            }

            .filter-tab {
                width: 100%;
                text-align: center;
            }

            /* Bookings Grid */
            .bookings-grid {
                gap: 0.5rem;
            }

            .booking-card {
                padding: 0.75rem;
            }

            .essential-row {
                font-size: 0.8rem;
            }

            .essential-label {
                min-width: 50px;
                font-size: 0.75rem;
            }

            .essential-value {
                font-size: 0.8rem;
            }

            /* Action Buttons */
            .action-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
                min-height: 32px;
                min-width: 70px;
            }

            /* Calendar - Extra Small Screens */
            .calendar-week .day {
                min-height: 45px;
                font-size: 0.75rem;
                padding: 0.15rem;
            }

            .calendar-week-header .day-header {
                font-size: 0.65rem;
                padding: 0.3rem 0.15rem;
            }

            .booking-info {
                font-size: 0.45rem;
                padding: 1px 2px;
            }

            .booking-count {
                font-size: 0.55rem;
            }

            .booking-preview {
                font-size: 0.45rem;
            }

            .calendar-legend {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
            }

            .legend-item {
                font-size: 0.65rem;
            }

            .legend-indicator {
                width: 8px;
                height: 8px;
            }

            /* Modals */
            .modal-content {
                width: 98%;
                margin: 5px;
                padding: 0.75rem;
            }

            .modal-header {
                padding: 0.75rem;
            }

            .modal-header h3 {
                font-size: 1.1rem;
            }

            .modal-body {
                padding: 0.75rem;
            }

            .modal-footer {
                padding: 0.75rem;
            }

            /* Booking Details */
            .booking-details-popup {
                width: 98%;
                margin: 5px;
                max-height: 95vh;
                overflow-y: auto;
            }

            .detail-popup-section {
                padding: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .detail-popup-section h4 {
                font-size: 0.9rem;
            }

            .detail-popup-row {
                font-size: 0.8rem;
            }

            .detail-popup-label {
                font-size: 0.75rem;
            }

            .detail-popup-value {
                font-size: 0.8rem;
            }

            .detail-popup-actions {
                gap: 0.4rem;
                margin-top: 0.75rem;
            }

            .detail-popup-actions .action-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                min-height: 36px;
                min-width: 90px;
                flex: 1;
                max-width: 150px;
            }

            /* Move Booking */
            .move-booking-modal {
                width: 98%;
                margin: 5px;
            }

            .info-card {
                padding: 0.5rem;
            }

            .info-item {
                padding: 0.5rem;
            }

            .move-calendar-grid .day {
                min-height: 35px;
                font-size: 0.8rem;
            }

            .move-calendar-grid .day-header {
                font-size: 0.7rem;
                padding: 0.25rem 0.2rem;
            }
        }

        @media (max-width: 360px) {
            /* Very small screens */
            .admin-container {
                padding: 80px 0.25rem 20px;
            }

            .admin-header h1 {
                font-size: 1.3rem;
            }

            .admin-header p {
                font-size: 0.85rem;
            }

            .stats-grid {
                gap: 0.5rem;
            }

            .stat-card {
                padding: 0.5rem;
            }

            .stat-card h3 {
                font-size: 1.1rem;
            }

            .stat-card p {
                font-size: 0.8rem;
            }

            .active-bookings-section,
            .history-section {
                padding: 1rem;
            }

            .section-header h2 {
                font-size: 1.1rem;
            }

            .booking-card {
                padding: 0.5rem;
            }

            .essential-row {
                font-size: 0.75rem;
            }

            .action-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
                min-height: 28px;
                min-width: 60px;
            }

            .calendar-week .day {
                min-height: 40px;
                font-size: 0.7rem;
                padding: 0.1rem;
            }

            .calendar-week-header .day-header {
                font-size: 0.6rem;
                padding: 0.25rem 0.1rem;
            }

            .booking-info {
                font-size: 0.4rem;
                padding: 1px;
            }

            .booking-count {
                font-size: 0.5rem;
            }

            .booking-preview {
                font-size: 0.4rem;
            }

            .legend-item {
                font-size: 0.6rem;
            }

            .legend-indicator {
                width: 6px;
                height: 6px;
            }

            .modal-content {
                padding: 0.5rem;
            }

            .modal-header {
                padding: 0.5rem;
            }

            .modal-body {
                padding: 0.5rem;
            }

            .modal-footer {
                padding: 0.5rem;
            }

            /* Booking Details Popup for very small screens */
            .booking-details-popup {
                width: 99%;
                margin: 2px;
                max-height: 98vh;
                padding: 0.5rem;
            }

            .detail-popup-actions {
                gap: 0.3rem;
                margin-top: 0.5rem;
            }

            .detail-popup-actions .action-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
                min-height: 32px;
                min-width: 80px;
                flex: 1;
                max-width: 120px;
            }

            /* Timeline styles for very small screens */
            .timeline-container {
                padding-left: 1.25rem;
            }

            .timeline-line {
                left: 0.75rem;
            }

            .timeline-dot {
                left: -0.75rem;
                width: 8px;
                height: 8px;
            }

            .date-column {
                width: 60px;
                margin-right: 0.4rem;
                padding: 0.25rem;
            }

            .day-name {
                font-size: 0.65rem;
            }

            .day-number {
                font-size: 1.1rem;
            }

            .status-block {
                padding: 0.15rem 0.3rem;
                font-size: 0.65rem;
                min-width: 60px;
                flex: 1;
                max-width: 120px;
            }

            /* Compact timeline items for very small screens */
            .timeline-item:has(.status-block) {
                margin-bottom: 0.3rem;
                padding: 0.15rem;
            }

            .timeline-item:has(.status-block) .timeline-dot {
                top: 0.5rem;
                width: 6px;
                height: 6px;
            }

            .timeline-item:has(.status-block) .date-column {
                width: 50px;
                margin-right: 0.3rem;
                padding: 0.15rem;
            }

            .timeline-item:has(.status-block) .day-name {
                font-size: 0.6rem;
            }

            .timeline-item:has(.status-block) .day-number {
                font-size: 1rem;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .admin-container {
                padding: 80px 1rem 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.75rem;
            }

            .bookings-container {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .history-section {
                max-height: 300px;
            }

            .calendar-grid .day {
                min-height: 50px;
            }

            .calendar-controls {
                flex-direction: row;
                gap: 1rem;
            }

            .calendar-legend {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .modal-content {
                max-height: 85vh;
            }

            .nav-links.active {
                max-height: 300px;
            }
        }

        /* Mobile Navigation Styles */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
        }

        .mobile-menu-toggle:hover {
            color: var(--accent-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-menu-toggle i {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .nav-links {
                position: fixed;
                top: 82px;
                left: 0;
                width: 100%;
                background: var(--primary-color);
                flex-direction: column;
                padding: 0;
                gap: 0;
                max-height: 0;
                overflow: hidden;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 999;
            }

            .nav-links.active {
                max-height: 400px;
                padding: 1rem 0;
            }

            .nav-links li {
                text-align: center;
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .nav-links.active li {
                opacity: 1;
                transform: translateY(0);
            }

            .nav-links.active li:nth-child(1) {
                transition-delay: 0.1s;
            }

            .nav-links.active li:nth-child(2) {
                transition-delay: 0.15s;
            }

            .nav-links.active li:nth-child(3) {
                transition-delay: 0.2s;
            }

            .nav-links.active li:nth-child(4) {
                transition-delay: 0.25s;
            }

            .nav-links.active li:nth-child(5) {
                transition-delay: 0.3s;
            }

            .nav-links.active li:nth-child(6) {
                transition-delay: 0.35s;
            }

            .nav-links a {
                display: block;
                padding: 1rem 2rem;
                font-size: 1.1rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .nav-links a:hover {
                background: rgba(255, 255, 255, 0.1);
                padding-left: 2.5rem;
            }

            .nav-links li:last-child a {
                border-bottom: none;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .action-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 0.75rem 1rem;
            }

            .filter-tab {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            .calendar-nav-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .nav-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .btn-primary,
            .btn-secondary {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            .modal-close {
                min-height: 44px;
                min-width: 44px;
            }

            .mobile-menu-toggle {
                min-height: 44px;
                min-width: 44px;
                padding: 0.75rem;
            }
        }

        /* Mobile Calendar Styles - Vertical Scrolling Only */
        @media (max-width: 768px) {
            .calendar-view {
                padding: 1rem;
                margin: 0 -1rem;
                border-radius: 0;
                border-left: none;
                border-right: none;
                overflow-x: hidden;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .calendar-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
                text-align: center;
                padding: 1rem 0;
                flex-direction: row;
            }

            .calendar-controls h3 {
                font-size: 1.25rem;
                margin: 0;
                flex: 1;
                text-align: center;
            }

            .calendar-nav-btn {
                min-height: 48px;
                min-width: 48px;
                font-size: 1.1rem;
                flex-shrink: 0;
            }

            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 0.5rem;
                margin-bottom: 1rem;
                overflow-x: hidden;
                overflow-y: visible;
            }

            .calendar-grid .day {
                min-height: 70px;
                font-size: 1rem;
                padding: 0.5rem;
                border-radius: 8px;
                aspect-ratio: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                word-break: break-word;
                overflow: hidden;
                min-width: 0;
                cursor: pointer;
            }

            .calendar-grid .day .date-number {
                font-weight: 600;
                margin-bottom: 0.25rem;
                font-size: 1.1rem;
            }

            .calendar-grid .day .booking-count {
                font-size: 0.8rem;
                opacity: 0.8;
                margin-top: 0.25rem;
            }

            /* Day name headers */
            .calendar-grid .day-name {
                font-weight: 600;
                color: var(--admin-secondary);
                font-size: 0.9rem;
                padding: 0.5rem;
                text-align: center;
                background: var(--admin-light-gray);
                border-radius: 6px;
                margin-bottom: 0.5rem;
            }

            /* Vertical Timeline Calendar Layout */
            .timeline-container {
                position: relative;
                padding-left: 2rem;
                margin-top: 1rem;
            }

            .timeline-line {
                position: absolute;
                left: 1.5rem;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--admin-border);
                z-index: 1;
            }

            .timeline-item {
                position: relative;
                display: flex;
                align-items: center;
                margin-bottom: 1rem;
                cursor: pointer;
                transition: all 0.2s ease;
                padding: 0.5rem;
                border-radius: 8px;
            }

            /* Compact timeline items for empty days */
            .timeline-item:has(.status-block) {
                margin-bottom: 0.5rem;
                padding: 0.25rem;
                align-items: center;
            }

            .timeline-item:has(.status-block) .timeline-dot {
                top: 0.75rem;
            }

            .timeline-item:hover {
                background: var(--admin-light-gray);
                transform: translateX(2px);
            }

            .timeline-item:has(.status-block):hover {
                background: var(--admin-light-gray);
                transform: translateX(1px);
            }

            .timeline-dot {
                position: absolute;
                left: -1.5rem;
                top: 1.5rem;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--admin-secondary);
                border: 2px solid white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                z-index: 2;
                transition: all 0.2s ease;
            }

            .timeline-dot.today {
                background: var(--admin-accent);
                transform: scale(1.2);
                box-shadow: 0 0 0 4px rgba(140, 198, 63, 0.2);
            }

            .timeline-dot.booked {
                background: var(--admin-info);
            }

            .timeline-dot.blocked {
                background: var(--admin-danger);
            }

            .timeline-dot.weekend {
                background: var(--admin-secondary);
            }

            .timeline-dot.available {
                background: var(--admin-success);
            }

            .date-column {
                flex-shrink: 0;
                width: 80px;
                text-align: center;
                margin-right: 0.75rem;
                padding: 0.5rem;
                background: white;
                border-radius: 6px;
                border: 1px solid var(--admin-border);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            /* Compact date column for empty days */
            .timeline-item:has(.status-block) .date-column {
                padding: 0.25rem;
                border-radius: 4px;
                width: 70px;
                margin-right: 0.5rem;
            }

            .timeline-item:has(.status-block) .day-name {
                font-size: 0.7rem;
                margin-bottom: 0.1rem;
            }

            .timeline-item:has(.status-block) .day-number {
                font-size: 1.2rem;
                margin-top: 0.1rem;
            }

            .day-name {
                font-size: 0.8rem;
                font-weight: 600;
                color: var(--admin-secondary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .day-number {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--admin-primary);
                margin-top: 0.25rem;
            }

            .events-column {
                flex: 1;
                min-width: 0;
                display: flex;
                align-items: center;
                justify-content: flex-start;
            }

            .event-block {
                background: white;
                border-radius: 8px;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                border-left: 4px solid var(--admin-info);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .event-block:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .event-block.pending {
                border-left-color: var(--admin-warning);
            }

            .event-block.confirmed {
                border-left-color: var(--admin-success);
            }

            .event-time {
                font-weight: 600;
                color: var(--admin-primary);
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }

            .event-customer {
                font-size: 0.85rem;
                color: var(--admin-secondary);
                margin-bottom: 0.25rem;
            }

            .event-status {
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .event-block.pending .event-status {
                color: var(--admin-warning);
            }

            .event-block.confirmed .event-status {
                color: var(--admin-success);
            }

            .status-block {
                background: var(--admin-light-gray);
                border-radius: 6px;
                padding: 0.4rem 0.75rem;
                text-align: center;
                font-size: 0.75rem;
                font-weight: 600;
                color: var(--admin-secondary);
                border: 1px solid var(--admin-border);
                display: inline-block;
                min-width: 80px;
                flex-shrink: 0;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .status-block:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }

            .status-block.available {
                background: rgba(40, 167, 69, 0.1);
                color: var(--admin-success);
                border-color: rgba(40, 167, 69, 0.3);
                min-width: 100px;
                flex: 1;
                max-width: 200px;
            }

            .status-block.blocked {
                background: rgba(220, 53, 69, 0.1);
                color: var(--admin-danger);
                border-color: rgba(220, 53, 69, 0.3);
                min-width: 100px;
                flex: 1;
                max-width: 200px;
            }

            .status-block.weekend {
                background: var(--admin-light-gray);
                color: var(--admin-secondary);
                min-width: 100px;
                flex: 1;
                max-width: 200px;
            }

            .calendar-legend {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-top: 1rem;
                padding: 1rem;
                background: var(--admin-light-gray);
                border-radius: 8px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
            }

            .legend-indicator {
                width: 16px;
                height: 16px;
                border-radius: 4px;
                flex-shrink: 0;
            }

            /* Ensure no horizontal scrolling */
            .bookings-section {
                overflow-x: hidden;
                overflow-y: auto;
            }

            /* Prevent horizontal scrolling on all calendar elements */
            .calendar-view * {
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Ensure calendar days don't overflow */
            .calendar-grid .day {
                max-width: 100%;
                min-width: 0;
                flex-shrink: 1;
            }

            /* Optimize touch targets */
            .calendar-grid .day {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            .filter-tabs {
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .filter-tabs::-webkit-scrollbar {
                display: none;
            }

            .filter-tab {
                white-space: nowrap;
                min-width: auto;
                flex-shrink: 0;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .calendar-view {
                padding: 0.75rem;
                margin: 0 -0.75rem;
            }

            .calendar-grid {
                gap: 0.35rem;
            }

            .calendar-grid .day {
                min-height: 60px;
                font-size: 0.9rem;
                padding: 0.4rem;
            }

            .calendar-grid .day .date-number {
                font-size: 1rem;
            }

            .calendar-grid .day .booking-count {
                font-size: 0.75rem;
            }

            .timeline-container {
                padding-left: 1.5rem;
            }

            .timeline-line {
                left: 1rem;
            }

            .timeline-dot {
                left: -1rem;
                width: 10px;
                height: 10px;
            }

            .date-column {
                width: 70px;
                margin-right: 0.6rem;
                padding: 0.4rem;
            }

            /* Compact styles for small screens */
            .timeline-item:has(.status-block) .date-column {
                width: 60px;
                margin-right: 0.4rem;
                padding: 0.2rem;
            }

            .day-name {
                font-size: 0.75rem;
            }

            .day-number {
                font-size: 1.3rem;
            }

            .event-block {
                padding: 0.6rem;
                margin-bottom: 0.4rem;
            }

            .event-time {
                font-size: 0.85rem;
            }

            .event-customer {
                font-size: 0.8rem;
            }

            .event-status {
                font-size: 0.7rem;
            }

            .status-block {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
                min-width: 70px;
                flex: 1;
                max-width: 150px;
            }

            /* Compact styles for small screens */
            .timeline-item:has(.status-block) {
                margin-bottom: 0.4rem;
                padding: 0.2rem;
            }

            .timeline-item:has(.status-block) .timeline-dot {
                top: 0.6rem;
                width: 8px;
                height: 8px;
            }

            .timeline-item:has(.status-block) .day-name {
                font-size: 0.65rem;
            }

            .timeline-item:has(.status-block) .day-number {
                font-size: 1.1rem;
            }

            .calendar-controls h3 {
                font-size: 1.1rem;
            }

            .calendar-nav-btn {
                min-height: 44px;
                min-width: 44px;
                font-size: 1rem;
            }

            .calendar-legend {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .legend-item {
                font-size: 0.85rem;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .calendar-view {
                padding: 0.5rem;
            }

            .calendar-grid {
                gap: 0.4rem;
            }

            .calendar-grid .day {
                min-height: 55px;
                font-size: 0.85rem;
                padding: 0.3rem;
            }

            .calendar-grid .day .date-number {
                font-size: 0.95rem;
            }

            .timeline-container {
                padding-left: 1.75rem;
            }

            .timeline-line {
                left: 1.25rem;
            }

            .timeline-dot {
                left: -1.25rem;
                width: 11px;
                height: 11px;
            }

            .date-column {
                width: 75px;
                margin-right: 0.75rem;
                padding: 0.35rem;
            }

            /* Compact styles for landscape */
            .timeline-item:has(.status-block) .date-column {
                width: 65px;
                margin-right: 0.5rem;
                padding: 0.25rem;
            }

            .day-name {
                font-size: 0.8rem;
            }

            .day-number {
                font-size: 1.4rem;
            }

            .event-block {
                padding: 0.65rem;
                margin-bottom: 0.35rem;
            }

            .event-time {
                font-size: 0.88rem;
            }

            .event-customer {
                font-size: 0.82rem;
            }

            .event-status {
                font-size: 0.72rem;
            }

            .status-block {
                padding: 0.15rem 0.35rem;
                font-size: 0.72rem;
                min-width: 75px;
                flex: 1;
                max-width: 160px;
            }

            /* Compact styles for landscape */
            .timeline-item:has(.status-block) {
                margin-bottom: 0.6rem;
                padding: 0.15rem;
            }

            .timeline-item:has(.status-block) .timeline-dot {
                top: 0.65rem;
                width: 9px;
                height: 9px;
            }

            .timeline-item:has(.status-block) .date-column {
                padding: 0.15rem;
                width: 70px;
            }

            .timeline-item:has(.status-block) .day-name {
                font-size: 0.68rem;
            }

            .timeline-item:has(.status-block) .day-number {
                font-size: 1.15rem;
            }

            .calendar-controls {
                flex-direction: row;
                gap: 0.5rem;
            }

            .calendar-controls h3 {
                font-size: 1rem;
            }
        }

        /* Quote Modal Styles */
        .quote-modal-content {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .quote-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .quote-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .quote-section h4 {
            color: var(--admin-primary);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--admin-text);
        }

        .form-group input {
            padding: 0.75rem;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 3px rgba(140, 198, 63, 0.1);
        }

        /* Service Items Styles */
        .service-items-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .service-item {
            background: var(--admin-light-gray);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--admin-border);
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .item-row input {
            padding: 0.5rem;
            border: 1px solid var(--admin-border);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .item-total-amount {
            font-weight: 600;
            color: var(--admin-primary);
        }

        .remove-item-btn {
            background: var(--admin-danger);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .remove-item-btn:hover {
            background: #c82333;
        }

        .add-item-btn {
            background: var(--admin-accent);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .add-item-btn:hover {
            background: #7ab32e;
            transform: translateY(-1px);
        }

        /* Tax Toggle Styles */
        .tax-toggle-container {
            margin-bottom: 1rem;
        }

        .tax-toggle-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }

        .tax-toggle-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--admin-accent);
        }

        /* Quote Totals Styles */
        .quote-totals {
            background: var(--admin-light-gray);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--admin-border);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-weight: 500;
        }

        .total-row.grand-total {
            border-top: 2px solid var(--admin-border);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--admin-primary);
        }

        .tax-row {
            color: var(--admin-secondary);
        }

        /* Quote Actions */
        .quote-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--admin-border);
        }

        .btn-secondary {
            background: var(--admin-secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .btn-success {
            background: var(--admin-success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* Quote Preview Styles */
        .quote-preview-content {
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .quote-preview {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .quote-preview-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Quote Document Styles */
        .quote-document {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            font-size: 12px;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .quote-header {
            background: white;
            color: #333;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #8cc63f;
        }

        .company-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .company-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border-radius: 4px;
        }

        .company-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 10px 0;
            letter-spacing: 0.3px;
        }

        .company-contact {
            margin-top: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 11px;
            color: #666;
        }

        .contact-item i {
            width: 12px;
            color: #8cc63f;
            text-align: center;
        }

        .document-info {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .document-type {
            font-size: 22px;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 8px;
            letter-spacing: 1.2px;
        }

        .document-number {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
        }

        .document-date {
            font-size: 12px;
            color: #666;
        }

        .client-billing-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 24px;
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin: 24px;
        }

        .section-heading {
            font-size: 15px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: #2c3e50;
            border-bottom: 2px solid #8cc63f;
            padding-bottom: 6px;
        }

        .data-row {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
            min-height: 16px;
        }

        .label {
            font-weight: 600;
            min-width: 70px;
            color: #555;
            font-size: 11px;
            flex-shrink: 0;
        }

        .value {
            flex: 1;
            color: #333;
            font-size: 11px;
            word-wrap: break-word;
        }

        .services-section {
            padding: 24px;
        }

        .services-table {
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            display: grid;
            grid-template-columns: 40px 1fr 60px 90px 90px;
            background: #2c3e50;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        .header-item {
            padding: 12px 10px;
            text-align: left;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-item:last-child {
            border-right: none;
        }

        .table-body {
            background: white;
        }

        .table-row {
            display: grid;
            grid-template-columns: 40px 1fr 60px 90px 90px;
            border-bottom: 1px solid #e1e8ed;
            font-size: 11px;
            min-height: 40px;
        }

        .table-row:nth-child(even) {
            background: #f8f9fa;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-cell {
            padding: 12px 10px;
            display: flex;
            align-items: center;
            border-right: 1px solid #e1e8ed;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-cell.description {
            font-weight: 500;
        }

        .table-cell.quantity {
            justify-content: center;
        }

        .table-cell.price, .table-cell.total {
            justify-content: flex-end;
            font-weight: 600;
        }

        .totals-section {
            padding: 0 24px 24px;
            display: flex;
            justify-content: flex-end;
        }

        .totals-container {
            width: 240px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            align-items: center;
            min-height: 20px;
        }

        .total-row.grand-total {
            border-top: 2px solid #8cc63f;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 15px;
            font-weight: 700;
            color: #2c3e50;
        }

        .total-label {
            font-weight: 600;
        }

        .total-value {
            font-weight: 600;
        }

        .terms-section {
            padding: 24px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
        }

        .terms-content p {
            margin: 0;
            font-size: 10px;
            color: #666;
            line-height: 1.3;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--admin-primary);
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .items-table th {
            background: var(--admin-accent);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .items-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .items-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 2rem;
        }

        .totals-table {
            width: 300px;
            border-collapse: collapse;
        }

        .totals-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .totals-table .total-row {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .terms-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 2rem;
        }

        .terms-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--admin-primary);
        }

        .terms-text {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        /* Customer Management Styles */
        .customer-view {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .customer-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .customer-search {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 3px rgba(140, 198, 63, 0.1);
        }

        .search-btn {
            background: var(--admin-accent);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #7ab33a;
            transform: translateY(-1px);
        }

        .customer-actions {
            display: flex;
            gap: 0.5rem;
        }

        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .customer-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .customer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .customer-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--admin-primary);
            margin-bottom: 0.25rem;
        }

        .customer-id {
            font-size: 0.8rem;
            color: var(--admin-secondary);
            font-family: 'Courier New', monospace;
        }

        .customer-contact {
            margin-bottom: 1rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .contact-item i {
            width: 16px;
            color: var(--admin-accent);
            font-size: 0.8rem;
        }

        .contact-label {
            font-weight: 500;
            color: var(--admin-secondary);
            min-width: 60px;
        }

        .contact-value {
            color: var(--admin-primary);
        }

        .customer-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            background: var(--admin-light-gray);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--admin-accent);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--admin-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .customer-actions-card {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .customer-action-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .customer-action-btn.view {
            background: var(--admin-info);
            color: white;
        }

        .customer-action-btn.edit {
            background: var(--admin-warning);
            color: white;
        }

        .customer-action-btn.delete {
            background: var(--admin-danger);
            color: white;
        }

        .customer-action-btn.info {
            background: var(--admin-info);
            color: white;
        }

        .customer-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Customer Details Styles */
        .customer-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .customer-info-section {
            background: var(--admin-light-gray);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .customer-info-section h4 {
            color: var(--admin-primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .customer-info-section h4 i {
            color: var(--admin-accent);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--admin-border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: var(--admin-secondary);
        }

        .info-value {
            color: var(--admin-primary);
            font-weight: 500;
        }

        .customer-history-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--admin-border);
        }

        .history-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--admin-border);
            padding-bottom: 0.5rem;
        }

        .history-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--admin-light-gray);
            color: var(--admin-secondary);
        }

        .history-tab.active {
            background: var(--admin-accent);
            color: white;
        }

        /* Enhanced History Item Styles */
        .enhanced-history-item {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--admin-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .booking-header {
            margin-bottom: 1rem;
        }

        .booking-header h5 {
            color: var(--admin-primary);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .booking-header h5 i {
            color: var(--admin-accent);
        }

        .booking-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--admin-secondary);
        }

        .booking-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .booking-meta i {
            color: var(--admin-accent);
        }

        .booking-details {
            background: var(--admin-light-gray);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }

        .detail-label {
            font-weight: 500;
            color: var(--admin-secondary);
            font-size: 0.9rem;
        }

        .detail-value {
            color: var(--admin-primary);
            font-size: 0.9rem;
        }

        .related-documents {
            border-top: 1px solid var(--admin-border);
            padding-top: 1rem;
        }

        .document-section {
            margin-bottom: 1rem;
        }

        .document-section h6 {
            color: var(--admin-primary);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .document-section h6 i {
            color: var(--admin-accent);
        }

        .document-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .document-item {
            background: var(--admin-light-gray);
            border-radius: 6px;
            padding: 0.75rem;
            border-left: 3px solid var(--admin-accent);
        }

        .document-item.quote-item {
            border-left-color: var(--admin-warning);
        }

        .document-item.invoice-item {
            border-left-color: var(--admin-info);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .document-id {
            font-weight: 600;
            color: var(--admin-primary);
            font-size: 0.9rem;
        }

        .document-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .document-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .document-status.approved {
            background: #d4edda;
            color: #155724;
        }

        .document-status.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .document-status.paid {
            background: #d1ecf1;
            color: #0c5460;
        }

        .document-status.unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .document-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .document-amount {
            font-weight: 600;
            color: var(--admin-accent);
            font-size: 0.9rem;
        }

        .document-services {
            color: var(--admin-secondary);
            font-size: 0.8rem;
            max-width: 60%;
            text-align: right;
        }

        .document-date {
            color: var(--admin-secondary);
            font-size: 0.75rem;
        }

        .no-documents {
            text-align: center;
            padding: 1rem;
            color: var(--admin-secondary);
            font-style: italic;
            background: var(--admin-light-gray);
            border-radius: 6px;
        }

        .no-documents i {
            margin-right: 0.5rem;
            color: var(--admin-accent);
        }

        .history-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--admin-light-gray);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--admin-accent);
        }

        .history-item h5 {
            margin: 0 0 0.5rem 0;
            color: var(--admin-primary);
            font-size: 1rem;
        }

        .history-item p {
            margin: 0.25rem 0;
            font-size: 0.85rem;
            color: var(--admin-secondary);
        }

        .history-item .date {
            font-size: 0.75rem;
            color: var(--admin-secondary);
            font-style: italic;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--admin-text);
        }

        .form-group input,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--admin-accent);
            box-shadow: 0 0 0 3px rgba(140, 198, 63, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .booking-actions {
                gap: 0.3rem;
                justify-content: center;
            }

            .action-btn {
                padding: 0.2rem 0.5rem;
                font-size: 0.65rem;
                min-height: 26px;
                min-width: 26px;
            }

            .quote-modal-content {
                width: 98%;
                margin: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .item-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .item-row > div {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .item-row > div::before {
                content: attr(data-label);
                font-weight: 500;
                min-width: 80px;
            }

            .quote-actions {
                flex-direction: column;
            }

            .quote-preview-actions {
                flex-direction: column;
            }

            .client-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .quote-header {
                flex-direction: column;
                gap: 1rem;
            }

            .quote-info {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <img src="images/logo.png" alt="Stellar Tree Management Logo" class="logo">
            <ul class="nav-links">
                <li><a href="./">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/projects">Projects</a></li>
                <li><a href="/contacts">Contact</a></li>
                <li><a href="/booking/">Book Now</a></li>
                <li><a href="/admin" class="active">Admin</a></li>
            </ul>
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal show">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Access Required</h3>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="form-group">
                        <label for="adminPassword">Admin Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter admin password">
                    </div>
                    <div id="loginError" class="error-message" style="display: none; color: #dc3545; margin-top: 1rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-primary" onclick="login()">Access Dashboard</button>
            </div>
        </div>
    </div>

    <div class="admin-container" id="adminContent" style="display: none;">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <p>Manage bookings and view statistics for Stellar Tree Management</p>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <h3 id="pendingCount">0</h3>
                <p>Pending Bookings</p>
            </div>
            <div class="stat-card confirmed">
                <h3 id="confirmedCount">0</h3>
                <p>Confirmed Bookings</p>
            </div>
            <div class="stat-card completed">
                <h3 id="completedCount">0</h3>
                <p>Completed</p>
            </div>
            <div class="stat-card cancelled">
                <h3 id="cancelledCount">0</h3>
                <p>Cancelled</p>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="bookings-container">
            <!-- Active Bookings Section -->
            <div class="active-bookings-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-check"></i> <span id="sectionTitle">Active Bookings</span></h2>
                    <button class="refresh-btn" onclick="loadBookings()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Modern Filter Tabs -->
                <div class="filter-tabs">
                    <!-- Booking Status Category -->
                    <div class="tab-category">
                        <div class="tab-category-title">Booking Status</div>
                        <div class="tab-row">
                            <div class="filter-tab active" data-filter="all">
                                <i class="fas fa-list"></i>
                                All Active
                            </div>
                            <div class="filter-tab" data-filter="pending">
                                <i class="fas fa-clock"></i>
                                Pending
                            </div>
                            <div class="filter-tab" data-filter="confirmed">
                                <i class="fas fa-check-circle"></i>
                                Confirmed
                            </div>
                        </div>
                    </div>

                    <!-- Management Views Category -->
                    <div class="tab-category">
                        <div class="tab-category-title">Management Views</div>
                        <div class="tab-row">
                            <div class="filter-tab" data-filter="all-bookings">
                                <i class="fas fa-calendar-alt"></i>
                                All Bookings
                            </div>
                            <div class="filter-tab" data-filter="calendar">
                                <i class="fas fa-calendar-week"></i>
                                Calendar View
                            </div>
                            <div class="filter-tab" data-filter="customers">
                                <i class="fas fa-users"></i>
                                Customer Management
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bookings Grid -->
                <div class="bookings-grid" id="activeBookingsGrid">
                    <div class="empty-state">Loading bookings...</div>
                </div>

                <!-- Calendar View -->
                <div class="calendar-view" id="calendarView" style="display: none;">
                    <div class="calendar-controls">
                        <button class="calendar-nav-btn" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonth">July 2025</h3>
                        <button class="calendar-nav-btn" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>
                    
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <span class="legend-indicator available"></span>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator booked"></span>
                            <span>Booked</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator blocked"></span>
                            <span>Blocked</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-indicator weekend"></span>
                            <span>Weekend</span>
                        </div>
                    </div>
                </div>

                <!-- Customer Management View -->
                <div class="customer-view" id="customerView" style="display: none;">
                    <div class="customer-controls">
                        <div class="customer-search">
                            <input type="text" id="customerSearchInput" placeholder="Search customers by name, email, phone, or address..." class="search-input">
                            <button class="search-btn" onclick="searchCustomers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="customer-actions">
                            <button class="action-btn confirm" onclick="showAddCustomerModal()">
                                <i class="fas fa-plus"></i> Add Customer
                            </button>
                            <button class="action-btn complete" onclick="migrateCustomers()">
                                <i class="fas fa-sync"></i> Migrate Existing
                            </button>
                            <button class="action-btn warning" onclick="recalculateCustomerTotals()">
                                <i class="fas fa-calculator"></i> Recalculate Totals
                            </button>
                            <button class="action-btn info" onclick="refreshCustomerData()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="customers-grid" id="customersGrid">
                        <div class="empty-state">Loading customers...</div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="history-section">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Recent History</h2>
                </div>
                <div id="historyContainer">
                    <div style="text-align: center; color: var(--admin-secondary); font-style: italic;">
                        No recent activity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="fas fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="Booking image">
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Booking Details</h3>
                <button class="modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Booking details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Date Blocking Modal -->
    <div id="dateBlockingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="blockingModalTitle">Manage Date</h3>
                <button class="modal-close" onclick="closeBlockingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="date-info">
                    <p><strong>Date:</strong> <span id="selectedDateDisplay"></span></p>
                    <p><strong>Status:</strong> <span id="dateStatusDisplay"></span></p>
                </div>
                <div class="blocking-actions">
                    <button class="action-btn confirm" onclick="toggleDateBlock()" id="toggleBlockBtn">
                        <i class="fas fa-lock"></i> Block Date
                    </button>
                    <button class="action-btn complete" onclick="unblockDate()" id="unblockBtn" style="display: none;">
                        <i class="fas fa-unlock"></i> Unblock Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBlockingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Booking Details Popup Modal -->
    <div id="bookingDetailsPopupModal" class="modal">
        <div class="modal-content booking-details-popup">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Booking Details</h3>
                <button class="modal-close" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="bookingDetailsPopupBody">
                <!-- Detailed booking information will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeBookingDetailsPopup()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Move Booking Modal -->
    <div id="moveBookingModal" class="modal">
        <div class="modal-content move-booking-modal">
            <div class="modal-header">
                <h3><i class="fas fa-arrows-alt"></i> Move Booking</h3>
                <button class="modal-close" onclick="closeMoveBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Booking Info Section -->
                <div class="move-booking-info">
                    <div class="info-card">
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <label>Current Date</label>
                                <span id="moveCurrentDate"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-user"></i>
                            <div>
                                <label>Customer</label>
                                <span id="moveCustomerName"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <label>Phone</label>
                                <span id="moveCustomerPhone"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <label>Address</label>
                                <span id="moveCustomerAddress"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tools"></i>
                            <div>
                                <label>Service</label>
                                <span id="moveService"></span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-hashtag"></i>
                            <div>
                                <label>Booking ID</label>
                                <span id="moveBookingId"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Selection Section -->
                <div class="move-date-selection">
                    <h4><i class="fas fa-calendar-plus"></i> Select New Date</h4>
                    
                    <!-- Calendar Navigation -->
                    <div class="move-calendar-nav">
                        <button class="nav-btn" onclick="changeMoveMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="moveCalendarMonth"></span>
                        <button class="nav-btn" onclick="changeMoveMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="move-calendar-grid" id="moveCalendarGrid">
                        <!-- Calendar will be populated here -->
                    </div>

                    <!-- Selected Date Display -->
                    <div class="selected-date-display" id="selectedDateDisplay" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <span>Selected: <strong id="selectedDateText"></strong></span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="move-actions">
                    <button class="action-btn confirm" id="moveConfirmBtn" onclick="moveBooking()" disabled>
                        <i class="fas fa-arrows-alt"></i> Move to Selected Date
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeMoveBookingModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Management Modals -->

    <!-- Add/Edit Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Add Customer</h3>
                <button class="modal-close" onclick="closeCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Name *</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email *</label>
                            <input type="email" id="customerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone *</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="customerAddress">Address</label>
                            <input type="text" id="customerAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerNotes">Notes</label>
                        <textarea id="customerNotes" rows="3" placeholder="Additional notes about the customer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveCustomer()">Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div id="customerDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h3 id="customerDetailsTitle">Customer Details</h3>
                <button class="modal-close" onclick="closeCustomerDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <!-- Customer details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerDetailsModal()">Close</button>
                <button type="button" class="btn-primary" onclick="editCustomer()">Edit Customer</button>
            </div>
        </div>
    </div>

    <script>
        let allBookings = [];
        let currentFilter = 'all';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let blockedDates = [];
        let selectedDate = null;
        
        // Customer Management Variables
        let allCustomers = [];
        let currentCustomerId = null;

        // Authentication
        function login() {
            const password = document.getElementById('adminPassword').value;
            const adminPassword = window.ADMIN_CONFIG ? window.ADMIN_CONFIG.PASSWORD : 'stellar2024';
            
            if (password === adminPassword) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                document.getElementById('loginModal').classList.remove('show');
                document.getElementById('adminContent').style.display = 'block';
                loadBookings();
            } else {
                document.getElementById('loginError').textContent = 'Invalid password';
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            location.reload();
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('adminAuthenticated') === 'true') {
                document.getElementById('loginModal').classList.remove('show');
                document.getElementById('adminContent').style.display = 'block';
                loadBookings();
            } else {
                // Add Enter key handler for password field
                document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });

        // Load bookings from API
        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                if (response.ok) {
                    allBookings = await response.json();
                    
                    // Debug: Check for bookings with images
                    const bookingsWithImages = allBookings.filter(booking => booking.images);
                    console.log('Loaded bookings:', allBookings.length);
                    console.log('Bookings with images:', bookingsWithImages.length);
                    if (bookingsWithImages.length > 0) {
                        console.log('Sample booking with images:', bookingsWithImages[0]);
                    }
                    
                    updateStatistics();
                    renderActiveBookings();
                    renderHistory();
                    if (currentFilter === 'calendar') {
                        renderCalendar();
                    }
                    // Initialize customer management if needed
                    if (currentFilter === 'customers') {
                        loadCustomers();
                    }
                } else {
                    showNotification('Failed to load bookings', 'error');
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                showNotification('Network error loading bookings', 'error');
            }
        }

        // Load blocked dates
        async function loadBlockedDates() {
            try {
                const response = await fetch('/api/blocked-dates');
                if (response.ok) {
                    blockedDates = await response.json();
                } else {
                    blockedDates = [];
                }
            } catch (error) {
                console.error('Error loading blocked dates:', error);
                blockedDates = [];
            }
        }

        // Update statistics
        function updateStatistics() {
            const stats = {
                pending: allBookings.filter(b => b.status === 'pending').length,
                confirmed: allBookings.filter(b => b.status === 'confirmed').length,
                completed: allBookings.filter(b => b.status === 'completed').length,
                cancelled: allBookings.filter(b => b.status === 'cancelled').length
            };

            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('confirmedCount').textContent = stats.confirmed;
            document.getElementById('completedCount').textContent = stats.completed;
            document.getElementById('cancelledCount').textContent = stats.cancelled;
        }

        // Render active bookings (pending and confirmed)
        function renderActiveBookings() {
            const grid = document.getElementById('activeBookingsGrid');
            
            // Apply filter
            let filteredBookings = [];
            
            if (currentFilter === 'all') {
                // Show only active bookings (pending and confirmed)
                filteredBookings = allBookings.filter(booking => 
                    booking.status === 'pending' || booking.status === 'confirmed'
                );
            } else if (currentFilter === 'pending') {
                filteredBookings = allBookings.filter(b => b.status === 'pending');
            } else if (currentFilter === 'confirmed') {
                filteredBookings = allBookings.filter(b => b.status === 'confirmed');
            } else if (currentFilter === 'all-bookings') {
                // Show all bookings including completed and cancelled
                filteredBookings = allBookings;
            }

            if (filteredBookings.length === 0) {
                grid.innerHTML = '<div class="empty-state">No bookings found</div>';
                return;
            }

            grid.innerHTML = filteredBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const statusClass = `status-${booking.status}`;
                const statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);

                let actionButtons = '';
                if (booking.status === 'pending') {
                    actionButtons = `
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'confirmed') {
                    actionButtons = `
                        <button class="action-btn complete" onclick="checkForQuoteAndComplete('${booking.booking_id}')">
                            <i class="fas fa-check-double"></i> Complete
                        </button>
                        <button class="action-btn quote" onclick="showQuoteModal(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                            <i class="fas fa-file-invoice-dollar"></i> Quote
                        </button>
                        <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'completed') {
                    actionButtons = `
                        <span class="status-badge status-completed">
                            <i class="fas fa-check-double"></i> Completed
                        </span>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (booking.status === 'cancelled') {
                    actionButtons = `
                        <span class="status-badge status-cancelled">
                            <i class="fas fa-times"></i> Cancelled
                        </span>
                        <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }

                const cardClass = booking.status === 'completed' ? 'completed' : 
                                 booking.status === 'cancelled' ? 'cancelled' : '';
                
                return `
                    <div class="booking-card ${cardClass}" onclick="showBookingDetailsPopup('${booking.booking_id}')">
                        <div class="booking-header">
                            <div class="booking-id">${booking.booking_id}</div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="booking-essentials">
                            <div class="essential-row">
                                <i class="fas fa-tools essential-icon"></i>
                                <span class="essential-label">Service:</span>
                                <span class="essential-value">${booking.service}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-calendar essential-icon"></i>
                                <span class="essential-label">Date:</span>
                                <span class="essential-value">${new Date(booking.date).toLocaleDateString('en-US', {
                                    weekday: 'short',
                                    month: 'short',
                                    day: 'numeric'
                                })}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-clock essential-icon"></i>
                                <span class="essential-label">Time:</span>
                                <span class="essential-value">${booking.time}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-user essential-icon"></i>
                                <span class="essential-label">Customer:</span>
                                <span class="essential-value">${booking.name}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-phone essential-icon"></i>
                                <span class="essential-label">Phone:</span>
                                <span class="essential-value">${booking.phone || 'N/A'}</span>
                            </div>
                            <div class="essential-row">
                                <i class="fas fa-map-marker-alt essential-icon"></i>
                                <span class="essential-label">Address:</span>
                                <span class="essential-value">${booking.address ? (booking.address.length > 30 ? booking.address.substring(0, 30) + '...' : booking.address) : 'N/A'}</span>
                            </div>
                            ${booking.images ? `
                            <div class="booking-images">
                                <div class="images-preview">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.slice(0, 3).map(imagePath => `
                                                    <img src="${imagePath}" alt="Booking image" class="booking-image-thumbnail" onclick="event.stopPropagation(); showImageModal('${imagePath}')">
                                                `).join('') + 
                                                (imageArray.length > 3 ? `
                                                    <div class="more-images">+${imageArray.length - 3}</div>
                                                ` : '');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="booking-actions" onclick="event.stopPropagation();">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
            
                    // Setup calendar drag and drop after rendering (only for calendar tab)
        if (currentFilter === 'calendar') {
            setupCalendarDragAndDrop();
        }
        }

        // Render history (completed and cancelled)
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            const historyBookings = allBookings.filter(booking => 
                booking.status === 'completed' || booking.status === 'cancelled'
            ).slice(0, 10); // Show last 10

            if (historyBookings.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--admin-secondary); font-style: italic;">No recent activity</div>';
                return;
            }

            container.innerHTML = historyBookings.map(booking => {
                const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const historyDate = new Date(booking.updated_at || booking.created_at).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                return `
                    <div class="history-item ${booking.status}">
                        <h4>${booking.service} - ${booking.name}</h4>
                        <p><strong>ID:</strong> ${booking.booking_id}</p>
                        <p><strong>Date:</strong> ${dateTime}</p>
                        <p><strong>Email:</strong> ${booking.email}</p>
                        <p><strong>Phone:</strong> ${booking.phone || 'N/A'}</p>
                        <p><strong>Address:</strong> ${booking.address || 'N/A'}</p>
                        <p class="history-date">${booking.status} on ${historyDate}</p>
                    </div>
                `;
            }).join('');
        }

        // Update booking status
        async function updateBookingStatus(bookingId, newStatus) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    showNotification(`Booking ${newStatus} successfully`, 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update booking', 'error');
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                showNotification('Network error updating booking', 'error');
            }
        }

        // Check for quote and complete booking
        async function checkForQuoteAndComplete(bookingId) {
            try {
                const booking = allBookings.find(b => b.booking_id === bookingId);
                if (!booking) {
                    showNotification('Booking not found', 'error');
                    return;
                }

                // Check if there's a quote for this booking
                const quoteResponse = await fetch(`/api/quotes/booking/${bookingId}`);
                if (quoteResponse.ok) {
                    const quotes = await quoteResponse.json();
                    if (quotes.length > 0) {
                        // Use the most recent quote
                        const latestQuote = quotes[0];
                        showInvoiceModal(latestQuote, booking);
                    } else {
                        // No quote found, ask user if they want to create one
                        if (confirm('No quote found for this booking. Would you like to create a quote first?')) {
                            showQuoteModal(booking);
                        } else {
                            // Complete without quote
                            await updateBookingStatus(bookingId, 'completed');
                        }
                    }
                } else {
                    showNotification('Error checking for quotes', 'error');
                }
            } catch (error) {
                console.error('Error checking for quote:', error);
                showNotification('Network error checking for quote', 'error');
            }
        }

        // Delete booking permanently
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to permanently delete this booking? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Booking deleted successfully', 'success');
                    loadBookings(); // Reload to get updated data
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to delete booking', 'error');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                showNotification('Network error deleting booking', 'error');
            }
        }

        // Filter functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-tab')) {
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                
                // Update filter
                currentFilter = e.target.dataset.filter;
                updateSectionTitle();
                
                // Show/hide appropriate view
                if (currentFilter === 'calendar') {
                    document.getElementById('activeBookingsGrid').style.display = 'none';
                    document.getElementById('calendarView').style.display = 'block';
                    loadBlockedDates().then(() => renderCalendar());
                } else {
                    document.getElementById('activeBookingsGrid').style.display = 'grid';
                    document.getElementById('calendarView').style.display = 'none';
                    renderActiveBookings();
                }
            }
        });

        // Update section title based on current filter
        function updateSectionTitle() {
            const sectionTitle = document.getElementById('sectionTitle');
            switch (currentFilter) {
                case 'all':
                    sectionTitle.textContent = 'Active Bookings';
                    break;
                case 'pending':
                    sectionTitle.textContent = 'Pending Bookings';
                    break;
                case 'confirmed':
                    sectionTitle.textContent = 'Confirmed Bookings';
                    break;
                case 'all-bookings':
                    sectionTitle.textContent = 'All Bookings';
                    break;
                case 'calendar':
                    sectionTitle.textContent = 'Calendar';
                    break;
                default:
                    sectionTitle.textContent = 'Active Bookings';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Calendar functions
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonth');
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear grid
            grid.innerHTML = '';
            
            // Check if we're on mobile
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile-friendly calendar with weeks
                renderMobileCalendar(grid);
            } else {
                // Desktop calendar (original grid layout)
                renderDesktopCalendar(grid);
            }
        }

        function renderMobileCalendar(grid) {
            // Create vertical timeline container
            const timelineContainer = document.createElement('div');
            timelineContainer.className = 'timeline-container';
            
            // Create vertical line
            const timelineLine = document.createElement('div');
            timelineLine.className = 'timeline-line';
            timelineContainer.appendChild(timelineLine);
            
            // Get all days in the current month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const today = new Date();
            
            // Generate timeline for each day in the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(currentYear, currentMonth, day);
                const dateString = currentDate.toISOString().split('T')[0];
                
                // Create timeline item
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                timelineItem.dataset.date = dateString;
                
                // Create timeline dot
                const timelineDot = document.createElement('div');
                timelineDot.className = 'timeline-dot';
                
                // Check if it's today
                if (currentDate.toDateString() === today.toDateString()) {
                    timelineDot.classList.add('today');
                }
                
                // Check if it's weekend
                const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                
                // Check if it's blocked
                const isBlocked = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
                );
                const isUnblockedWeekend = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
                );
                
                // Set dot color based on status
                if (isBlocked) {
                    timelineDot.classList.add('blocked');
                } else if (isWeekend && !isUnblockedWeekend) {
                    timelineDot.classList.add('weekend');
                } else if (isUnblockedWeekend) {
                    timelineDot.classList.add('available');
                }
                
                // Create date column
                const dateColumn = document.createElement('div');
                dateColumn.className = 'date-column';
                
                const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = currentDate.getDate();
                
                dateColumn.innerHTML = `
                    <div class="day-name">${dayName}</div>
                    <div class="day-number">${dayNumber}</div>
                `;
                
                // Create events column
                const eventsColumn = document.createElement('div');
                eventsColumn.className = 'events-column';
                
                // Check for bookings
                const dayBookings = allBookings.filter(booking => 
                    booking.date === dateString && 
                    (booking.status === 'confirmed' || booking.status === 'pending')
                );
                
                if (dayBookings.length > 0) {
                    timelineDot.classList.add('booked');
                    
                    // Create booking events
                    dayBookings.forEach(booking => {
                        const eventBlock = document.createElement('div');
                        eventBlock.className = `event-block ${booking.status}`;
                        eventBlock.dataset.bookingId = booking.id;
                        
                        const timeSlot = booking.time || 'TBD';
                        const customerName = booking.name || 'Unknown';
                        
                        eventBlock.innerHTML = `
                            <div class="event-time">${timeSlot}</div>
                            <div class="event-customer">${customerName}</div>
                            <div class="event-status">${booking.status}</div>
                        `;
                        
                        // Add click handler for booking details
                        eventBlock.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showBookingDetails(booking);
                        });
                        
                        eventsColumn.appendChild(eventBlock);
                    });
                } else {
                    // Show availability status
                    let statusText = 'Available';
                    let statusClass = 'available';
                    
                    if (isBlocked) {
                        statusText = 'Blocked';
                        statusClass = 'blocked';
                    } else if (isWeekend && !isUnblockedWeekend) {
                        statusText = 'Weekend';
                        statusClass = 'weekend';
                    }
                    
                    const statusBlock = document.createElement('div');
                    statusBlock.className = `status-block ${statusClass}`;
                    statusBlock.textContent = statusText;
                    eventsColumn.appendChild(statusBlock);
                }
                
                // Add click handler for day management
                timelineItem.addEventListener('click', () => handleDayClick(currentDate, dayBookings));
                
                // Add drag and drop handlers
                timelineItem.addEventListener('dragover', handleCalendarDragOver);
                timelineItem.addEventListener('drop', handleCalendarDrop);
                timelineItem.addEventListener('dragenter', handleCalendarDragEnter);
                timelineItem.addEventListener('dragleave', handleCalendarDragLeave);
                
                // Assemble timeline item
                timelineItem.appendChild(timelineDot);
                timelineItem.appendChild(dateColumn);
                timelineItem.appendChild(eventsColumn);
                
                timelineContainer.appendChild(timelineItem);
            }
            
            grid.appendChild(timelineContainer);
        }

        function renderDesktopCalendar(grid) {
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                header.style.fontWeight = 'bold';
                header.style.color = 'var(--admin-primary)';
                grid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateString = currentDate.toISOString().split('T')[0];
                
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = currentDate.getDate();
                dayElement.dataset.date = dateString;
                
                // Check if it's current month
                if (currentDate.getMonth() !== currentMonth) {
                    dayElement.style.opacity = '0.3';
                }
                
                // Check if it's today
                const today = new Date();
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if it's weekend (automatically blocked)
                const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                
                // Check if it's blocked
                const isBlocked = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
                );
                const isUnblockedWeekend = blockedDates.some(blockedDate => 
                    blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
                );
                
                if (isBlocked) {
                    dayElement.classList.add('blocked');
                } else if (isWeekend && !isUnblockedWeekend) {
                    // Weekends are blocked by default unless explicitly unblocked
                    dayElement.classList.add('weekend');
                } else if (isUnblockedWeekend) {
                    // Unblocked weekends show as available
                    dayElement.classList.add('available');
                }
                
                // Check if it's booked
                const dayBookings = allBookings.filter(booking => 
                    booking.date === dateString && 
                    (booking.status === 'confirmed' || booking.status === 'pending')
                );
                if (dayBookings.length > 0) {
                    dayElement.classList.add('booked');
                    // Add booking info to the day
                    const bookingInfo = document.createElement('div');
                    bookingInfo.className = 'booking-info';
                    
                    // Group bookings by time slot
                    const timeSlots = ['8:00 AM', '1:00 PM', '4:00 PM'];
                    const bookedTimeSlots = timeSlots.filter(time => 
                        dayBookings.some(booking => booking.time === time)
                    );
                    
                    bookingInfo.innerHTML = `
                        <div class="booking-count">${dayBookings.length}</div>
                        <div class="booking-preview">${bookedTimeSlots.join(', ')}</div>
                    `;
                    dayElement.appendChild(bookingInfo);
                }
                
                // Add click handler
                dayElement.addEventListener('click', () => handleDayClick(currentDate, dayBookings));
                
                // Add drag and drop handlers for calendar days
                dayElement.addEventListener('dragover', handleCalendarDragOver);
                dayElement.addEventListener('drop', handleCalendarDrop);
                dayElement.addEventListener('dragenter', handleCalendarDragEnter);
                dayElement.addEventListener('dragleave', handleCalendarDragLeave);
                
                grid.appendChild(dayElement);
            }
        }

        function handleDayClick(date, bookings) {
            const dateString = date.toISOString().split('T')[0];
            const isBlocked = blockedDates.some(blockedDate => 
                blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
            );
            const isUnblockedWeekend = blockedDates.some(blockedDate => 
                blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
            );
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            if (bookings.length > 0) {
                // Show booking details
                showBookingDetails(date, bookings);
            } else if (isBlocked) {
                // Show unblock option for manually blocked dates
                showBlockingModal(date, true);
            } else if (isWeekend && isUnblockedWeekend) {
                // Show re-block option for unblocked weekends
                showBlockingModal(date, 'unblocked_weekend');
            } else if (isWeekend) {
                // Show make available option for blocked weekends
                showBlockingModal(date, 'weekend');
            } else {
                // Show blocking management for available dates
                showBlockingModal(date, false);
            }
        }

        function showCalendarPopup(date, bookings) {
            const modal = document.getElementById('bookingDetailsModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const dateString = date.toISOString().split('T')[0];
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const isBlocked = blockedDates.some(d => d.date === dateString);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            
            // Clear existing modal structure and create clean content
            modalContent.innerHTML = '';
            
            let popupContent = `
                <div class="calendar-popup-compact">
                    <div class="calendar-popup-header">
                        <div class="calendar-popup-date">${formattedDate}</div>
                        <button class="calendar-popup-close" onclick="closeModal('bookingDetailsModal')">&times;</button>
                    </div>
                    <div class="calendar-popup-content">
            `;
            
            if (bookings.length > 0) {
                bookings.forEach(booking => {
                    popupContent += `
                        <div class="calendar-booking-preview" onclick="showBookingDetailsPopup('${booking.booking_id}')">
                            <h4>${booking.service}</h4>
                            <p>${booking.time}  ${booking.name}</p>
                        </div>
                    `;
                });
            } else {
                popupContent += `
                    <div class="calendar-booking-preview" style="border-left-color: #6c757d;">
                        <h4>No Bookings</h4>
                        <p>This date is available</p>
                    </div>
                `;
            }
            
            popupContent += `
                    </div>
                    <div class="calendar-popup-actions">
            `;
            
            if (isWeekend) {
                if (isBlocked) {
                    popupContent += `<button class="calendar-popup-btn primary" onclick="unblockWeekend('${dateString}')">Make Available</button>`;
                } else {
                    popupContent += `<button class="calendar-popup-btn secondary" onclick="reblockWeekend('${dateString}')">Block Weekend</button>`;
                }
            } else {
                if (isBlocked) {
                    popupContent += `<button class="calendar-popup-btn primary" onclick="unblockDate('${dateString}')">Unblock Date</button>`;
                } else {
                    popupContent += `<button class="calendar-popup-btn secondary" onclick="toggleDateBlock('${dateString}')">Block Date</button>`;
                }
            }
            
            popupContent += `
                    </div>
                </div>
            `;
            
            modalContent.innerHTML = popupContent;
            openModal('bookingDetailsModal');
        }

        function showBookingDetails(date, bookings) {
            showCalendarPopup(date, bookings);
        }

        function showBlockingModal(date, isBlocked) {
            const modal = document.getElementById('dateBlockingModal');
            const dateDisplay = document.getElementById('selectedDateDisplay');
            const statusDisplay = document.getElementById('dateStatusDisplay');
            const toggleBtn = document.getElementById('toggleBlockBtn');
            const unblockBtn = document.getElementById('unblockBtn');
            
            selectedDate = date;
            const dateString = date.toISOString().split('T')[0];
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            dateDisplay.textContent = formattedDate;
            
            if (isBlocked === 'weekend') {
                // Weekend - show make available option
                statusDisplay.textContent = 'Weekend';
                statusDisplay.style.color = 'var(--admin-primary)';
                toggleBtn.innerHTML = '<i class="fas fa-unlock"></i> Make Available';
                toggleBtn.className = 'action-btn confirm';
                toggleBtn.onclick = () => unblockWeekend(dateString);
                toggleBtn.style.display = 'inline-flex';
                unblockBtn.style.display = 'none';
            } else if (isBlocked === 'unblocked_weekend') {
                // Unblocked weekend - show re-block option
                statusDisplay.textContent = 'Weekend (Available)';
                statusDisplay.style.color = 'var(--admin-success)';
                toggleBtn.innerHTML = '<i class="fas fa-lock"></i> Block Weekend';
                toggleBtn.className = 'action-btn cancel';
                toggleBtn.onclick = () => reblockWeekend(dateString);
                toggleBtn.style.display = 'inline-flex';
                unblockBtn.style.display = 'none';
            } else if (isBlocked) {
                // Manually blocked date - show unblock option
                statusDisplay.textContent = 'Blocked';
                statusDisplay.style.color = 'var(--admin-danger)';
                toggleBtn.style.display = 'none';
                unblockBtn.style.display = 'inline-flex';
            } else {
                // Available date - show block option
                statusDisplay.textContent = 'Available';
                statusDisplay.style.color = 'var(--admin-success)';
                toggleBtn.innerHTML = '<i class="fas fa-lock"></i> Block Date';
                toggleBtn.className = 'action-btn confirm';
                toggleBtn.onclick = () => toggleDateBlock();
                toggleBtn.style.display = 'inline-flex';
                unblockBtn.style.display = 'none';
            }
            
            openModal('dateBlockingModal');
        }

        function closeBookingModal() {
            document.getElementById('bookingDetailsModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function closeBlockingModal() {
            document.getElementById('dateBlockingModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        let moveBookingData = null;
        let moveCalendarMonth = new Date();
        let selectedMoveDate = null;

        function showMoveBookingModal(bookingId, currentDate) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            moveBookingData = booking;
            moveCalendarMonth = new Date();
            selectedMoveDate = null;

            // Populate booking info
            document.getElementById('moveBookingId').textContent = booking.booking_id;
            document.getElementById('moveCurrentDate').textContent = new Date(booking.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('moveCustomerName').textContent = booking.name;
            document.getElementById('moveCustomerPhone').textContent = booking.phone || 'Not provided';
            document.getElementById('moveCustomerAddress').textContent = booking.address || 'Not provided';
            document.getElementById('moveService').textContent = booking.service;

            // Reset UI
            document.getElementById('selectedDateDisplay').style.display = 'none';
            document.getElementById('moveConfirmBtn').disabled = true;

            // Render move calendar
            renderMoveCalendar();

            openModal('moveBookingModal');
        }

        function closeMoveBookingModal() {
            document.getElementById('moveBookingModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            moveBookingData = null;
            selectedMoveDate = null;
        }

        function showBookingDetailsPopup(bookingId) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            const dateTime = new Date(booking.date + 'T' + booking.time).toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const createdDate = new Date(booking.created_at).toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });

            const statusClass = `status-${booking.status}`;
            const statusText = booking.status.charAt(0).toUpperCase() + booking.status.slice(1);

            let actionButtons = '';
            if (booking.status === 'pending') {
                actionButtons = `
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'confirmed') {
                actionButtons = `
                    <button class="action-btn complete" onclick="updateBookingStatus('${booking.booking_id}', 'completed')">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'completed') {
                actionButtons = `
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                        <i class="fas fa-undo"></i> Reopen
                    </button>
                    <button class="action-btn cancel" onclick="updateBookingStatus('${booking.booking_id}', 'cancelled')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            } else if (booking.status === 'cancelled') {
                actionButtons = `
                    <button class="action-btn confirm" onclick="updateBookingStatus('${booking.booking_id}', 'confirmed')">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button class="action-btn complete" onclick="updateBookingStatus('${booking.booking_id}', 'completed')">
                        <i class="fas fa-check-double"></i> Complete
                    </button>
                    <button class="action-btn move" onclick="showMoveBookingModal('${booking.booking_id}', '${booking.date}')">
                        <i class="fas fa-arrows-alt"></i> Move
                    </button>
                    <button class="action-btn delete" onclick="deleteBooking('${booking.booking_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
            }

            const modalBody = document.getElementById('bookingDetailsPopupBody');
            modalBody.innerHTML = `
                <div class="detail-popup-grid">
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-info-circle"></i> Booking Info</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">ID:</span>
                            <span class="detail-popup-value">${booking.booking_id}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Status:</span>
                            <span class="detail-popup-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Service:</span>
                            <span class="detail-popup-value">${booking.service}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-calendar-alt"></i> Schedule</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Date:</span>
                            <span class="detail-popup-value">${dateTime}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Created:</span>
                            <span class="detail-popup-value">${createdDate}</span>
                        </div>
                    </div>

                    <div class="detail-popup-section">
                        <h4><i class="fas fa-user"></i> Customer</h4>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Name:</span>
                            <span class="detail-popup-value">${booking.name}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Email:</span>
                            <span class="detail-popup-value">${booking.email}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Phone:</span>
                            <span class="detail-popup-value">${booking.phone || 'Not provided'}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Address:</span>
                            <span class="detail-popup-value">${booking.address || 'Not provided'}</span>
                        </div>
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Notes:</span>
                            <div class="detail-popup-value">
                                <textarea id="bookingNotes" class="notes-textarea" placeholder="Add your personal notes here...">${booking.notes || ''}</textarea>
                                <button class="action-btn confirm" onclick="updateBookingNotes('${booking.booking_id}')" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Save Notes
                                </button>
                            </div>
                        </div>
                        ${booking.images ? `
                        <div class="detail-popup-row">
                            <span class="detail-popup-label">Images:</span>
                            <div class="detail-popup-value">
                                <div class="booking-images-detail">
                                    ${(() => {
                                        try {
                                            const imageArray = JSON.parse(booking.images);
                                            if (Array.isArray(imageArray) && imageArray.length > 0) {
                                                return imageArray.map(imagePath => `
                                                    <img src="${imagePath}" alt="Booking image" class="booking-image-detail" onclick="showImageModal('${imagePath}')">
                                                `).join('');
                                            }
                                        } catch (e) {
                                            console.error('Error parsing images for booking details:', booking.booking_id, e);
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    ${actionButtons ? `
                    <div class="detail-popup-section">
                        <h4><i class="fas fa-cogs"></i> Actions</h4>
                        <div class="detail-popup-actions">
                            ${actionButtons}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            openModal('bookingDetailsPopupModal');
        }

        function closeBookingDetailsPopup() {
            document.getElementById('bookingDetailsPopupModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function renderMoveCalendar() {
            const year = moveCalendarMonth.getFullYear();
            const month = moveCalendarMonth.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('moveCalendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day and last day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const grid = document.getElementById('moveCalendarGrid');
            grid.innerHTML = '';
            
            // Add day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'day';
                dayElement.textContent = currentDate.getDate();
                
                // Check if it's current month
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                // Check if it's today
                const today = new Date();
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if it's in the past
                if (currentDate < today) {
                    dayElement.classList.add('disabled');
                } else {
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    // Check if it's the current booking date
                    if (moveBookingData && dateString === moveBookingData.date) {
                        dayElement.classList.add('disabled');
                        dayElement.title = 'Current booking date';
                    } else {
                        // Check if it's booked
                        const dayBookings = allBookings.filter(booking => 
                            booking.date === dateString && 
                            (booking.status === 'confirmed' || booking.status === 'pending')
                        );
                        
                        if (dayBookings.length > 0) {
                            dayElement.classList.add('booked');
                            dayElement.title = 'Already booked';
                        } else {
                            // Check if it's blocked
                            const isBlocked = blockedDates.some(blockedDate => 
                                blockedDate.date === dateString && blockedDate.reason !== 'unblocked_weekend'
                            );
                            const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                            const isUnblockedWeekend = blockedDates.some(blockedDate => 
                                blockedDate.date === dateString && blockedDate.reason === 'unblocked_weekend'
                            );
                            
                            if (isBlocked || (isWeekend && !isUnblockedWeekend)) {
                                dayElement.classList.add('blocked');
                                dayElement.title = 'Date blocked';
                            } else {
                                dayElement.classList.add('available');
                                dayElement.addEventListener('click', () => selectMoveDate(currentDate, dateString));
                            }
                        }
                    }
                }
                
                grid.appendChild(dayElement);
            }
        }

        function changeMoveMonth(direction) {
            moveCalendarMonth.setMonth(moveCalendarMonth.getMonth() + direction);
            renderMoveCalendar();
        }

        function selectMoveDate(date, dateString) {
            // Remove previous selection
            document.querySelectorAll('.move-calendar-grid .day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Add selection to clicked day
            const dayElements = document.querySelectorAll('.move-calendar-grid .day');
            const dayIndex = Array.from(dayElements).findIndex(day => 
                day.textContent == date.getDate() && 
                !day.classList.contains('other-month')
            );
            
            if (dayIndex !== -1) {
                dayElements[dayIndex].classList.add('selected');
            }
            
            selectedMoveDate = dateString;
            
            // Update selected date display
            const selectedDateText = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('selectedDateText').textContent = selectedDateText;
            document.getElementById('selectedDateDisplay').style.display = 'flex';
            document.getElementById('moveConfirmBtn').disabled = false;
        }

        async function moveBooking() {
            if (!selectedMoveDate || !moveBookingData) {
                showNotification('Please select a new date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${moveBookingData.booking_id}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newDate: selectedMoveDate })
                });

                if (response.ok) {
                    showNotification('Booking moved successfully', 'success');
                    closeMoveBookingModal();
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to move booking', 'error');
                }
            } catch (error) {
                console.error('Error moving booking:', error);
                showNotification('Network error moving booking', 'error');
            }
        }

        async function toggleDateBlock() {
            if (!selectedDate) return;
            
            const dateString = selectedDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch('/api/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date: dateString })
                });
                
                if (response.ok) {
                    showNotification('Date blocked successfully', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    showNotification('Failed to block date', 'error');
                }
            } catch (error) {
                console.error('Error blocking date:', error);
                showNotification('Network error blocking date', 'error');
            }
        }

        async function unblockWeekend(dateString) {
            try {
                // Add the weekend to blocked dates with a special flag to indicate it's unblocked
                const response = await fetch('/api/blocked-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        date: dateString,
                        unblockWeekend: true 
                    })
                });

                if (response.ok) {
                    showNotification('Weekend made available for booking', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to make weekend available', 'error');
                }
            } catch (error) {
                console.error('Error making weekend available:', error);
                showNotification('Network error making weekend available', 'error');
            }
        }

        async function reblockWeekend(dateString) {
            try {
                // Remove the weekend from blocked dates to re-block it
                const response = await fetch(`/api/blocked-dates/${dateString}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Weekend blocked successfully', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to block weekend', 'error');
                }
            } catch (error) {
                console.error('Error blocking weekend:', error);
                showNotification('Network error blocking weekend', 'error');
            }
        }

        async function unblockDate() {
            if (!selectedDate) return;
            
            const dateString = selectedDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch(`/api/blocked-dates/${dateString}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Date unblocked successfully', 'success');
                    closeBlockingModal();
                    // Reload blocked dates and re-render calendar
                    await loadBlockedDates();
                    renderCalendar();
                } else {
                    showNotification('Failed to unblock date', 'error');
                }
            } catch (error) {
                console.error('Error unblocking date:', error);
                showNotification('Network error unblocking date', 'error');
            }
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // Calendar Drag and Drop functionality
        function setupCalendarDragAndDrop() {
            const bookedDays = document.querySelectorAll('.calendar-grid .day.booked');
            
            bookedDays.forEach(day => {
                day.draggable = true;
                day.addEventListener('dragstart', handleCalendarDragStart);
                day.addEventListener('dragend', handleCalendarDragEnd);
            });
        }

        function handleCalendarDragStart(e) {
            e.target.classList.add('dragging');
            const dateString = e.target.dataset.date;
            e.dataTransfer.setData('text/plain', dateString);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleCalendarDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.day.drag-over').forEach(day => {
                day.classList.remove('drag-over');
            });
        }

        function handleCalendarDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleCalendarDragEnter(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (day && !day.classList.contains('booked') && !day.classList.contains('blocked')) {
                day.classList.add('drag-over');
            }
        }

        function handleCalendarDragLeave(e) {
            const day = e.target.closest('.day');
            if (day) {
                day.classList.remove('drag-over');
            }
        }

        async function handleCalendarDrop(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (!day) return;

            const sourceDate = e.dataTransfer.getData('text/plain');
            const targetDate = day.dataset.date;

            if (!sourceDate || !targetDate || sourceDate === targetDate) return;

            // Check if the target date is available
            if (day.classList.contains('booked') || day.classList.contains('blocked')) {
                showNotification('Cannot move booking to unavailable date', 'error');
                return;
            }

            // Get bookings for the source date
            const sourceBookings = allBookings.filter(booking => 
                booking.date === sourceDate && 
                (booking.status === 'confirmed' || booking.status === 'pending')
            );

            if (sourceBookings.length === 0) {
                showNotification('No bookings found for source date', 'error');
                return;
            }

            // Move all bookings from source to target date
            try {
                for (const booking of sourceBookings) {
                    const response = await fetch(`/api/bookings/${booking.booking_id}/move`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ newDate: targetDate })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        showNotification(error.message || 'Failed to move booking', 'error');
                        return;
                    }
                }

                showNotification(`Moved ${sourceBookings.length} booking(s) successfully`, 'success');
                loadBookings(); // Reload to update the display
            } catch (error) {
                console.error('Error moving bookings:', error);
                showNotification('Network error moving bookings', 'error');
            }

            day.classList.remove('drag-over');
        }

        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.bookingId);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.day.drag-over').forEach(day => {
                day.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (day && !day.classList.contains('booked') && !day.classList.contains('blocked')) {
                day.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const day = e.target.closest('.day');
            if (day) {
                day.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            const day = e.target.closest('.day');
            if (!day) return;

            const bookingId = e.dataTransfer.getData('text/plain');
            const newDate = day.dataset.date;

            if (!newDate) return;

            // Check if the target date is available
            if (day.classList.contains('booked') || day.classList.contains('blocked')) {
                showNotification('Cannot move booking to unavailable date', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/bookings/${bookingId}/move`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newDate: newDate })
                });

                if (response.ok) {
                    showNotification('Booking moved successfully', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to move booking', 'error');
                }
            } catch (error) {
                console.error('Error moving booking:', error);
                showNotification('Network error moving booking', 'error');
            }

            day.classList.remove('drag-over');
        }

        // Update booking notes
        async function updateBookingNotes(bookingId) {
            const notesTextarea = document.getElementById('bookingNotes');
            const notes = notesTextarea.value.trim();

            try {
                const response = await fetch(`/api/bookings/${bookingId}/notes`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes })
                });

                if (response.ok) {
                    showNotification('Notes updated successfully', 'success');
                    // Update the booking in the local array
                    const booking = allBookings.find(b => b.booking_id === bookingId);
                    if (booking) {
                        booking.notes = notes;
                    }
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to update notes', 'error');
                }
            } catch (error) {
                console.error('Error updating notes:', error);
                showNotification('Network error updating notes', 'error');
            }
        }

        // Modal management functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        // Close modal when clicking outside
        function setupModalClickOutside() {
            document.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // Close modal with Escape key
        function setupModalEscapeKey() {
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.show');
                    if (modals.length > 0) {
                        closeModal(modals[0].id);
                    }
                }
            });
        }

        // Initialize modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            setupModalClickOutside();
            setupModalEscapeKey();
        });

        // Mobile Menu Functionality
        const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
        const navLinks = document.querySelector('.nav-links');
        const menuIcon = mobileMenuToggle.querySelector('i');

        mobileMenuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');

            // Toggle icon between bars and times with rotation
            if (navLinks.classList.contains('active')) {
                menuIcon.classList.remove('fa-bars');
                menuIcon.classList.add('fa-times');
                menuIcon.style.transform = 'rotate(180deg)';
            } else {
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking on a link
        navLinks.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('nav')) {
                navLinks.classList.remove('active');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
                menuIcon.style.transform = 'rotate(0deg)';
            }
        });

        // Handle window resize for calendar layout
        window.addEventListener('resize', function() {
            if (currentFilter === 'calendar') {
                renderCalendar();
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(loadBookings, 30000);

        // Quote Generation Variables
        let currentQuoteData = null;
        let itemCounter = 1;

        // Show Quote Modal
        async function showQuoteModal(booking) {
            // If booking is passed as a string (from onclick), parse it
            if (typeof booking === 'string') {
                try {
                    booking = JSON.parse(booking);
                } catch (e) {
                    console.error('Error parsing booking data:', e);
                    return;
                }
            }

            currentQuoteData = {
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes
            };

            // Check if there's an existing quote for this booking
            try {
                const quoteResponse = await fetch(`/api/quotes/booking/${booking.booking_id}`);
                if (quoteResponse.ok) {
                    const quotes = await quoteResponse.json();
                    if (quotes.length > 0) {
                        // Use the most recent quote
                        const existingQuote = quotes[0];
                        loadExistingQuote(existingQuote);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error checking for existing quotes:', error);
            }

            // No existing quote found, create new one
            loadNewQuote(booking);
        }

        // Load existing quote data
        function loadExistingQuote(quote) {
            // Store the quote ID for updates
            currentQuoteData.quoteId = quote.quote_id;

            // Pre-fill client information from saved quote
            document.getElementById('quoteClientName').value = quote.client_name || '';
            document.getElementById('quoteClientPhone').value = quote.client_phone || '';
            document.getElementById('quoteClientAddress').value = quote.client_address || '';
            document.getElementById('quoteClientEmail').value = quote.client_email || '';
            document.getElementById('quoteDate').value = quote.quote_date || new Date().toISOString().split('T')[0];

            // Load service items from saved quote
            // Handle both string and object formats
            let serviceItems;
            if (typeof quote.service_items === 'string') {
                try {
                    serviceItems = JSON.parse(quote.service_items);
                } catch (e) {
                    console.error('Error parsing service items:', e);
                    serviceItems = [];
                }
            } else {
                serviceItems = quote.service_items || [];
            }
            loadServiceItems(serviceItems);

            // Set tax toggle
            document.getElementById('taxToggle').checked = quote.tax_enabled || false;

            // Update totals
            updateQuoteTotals();

            // Setup event listeners for all service items
            document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

            // Show modal
            openModal('quoteModal');
        }

        // Load new quote (no existing data)
        function loadNewQuote(booking) {
            // Pre-fill client information from booking
            document.getElementById('quoteClientName').value = booking.name || '';
            document.getElementById('quoteClientPhone').value = booking.phone || '';
            document.getElementById('quoteClientAddress').value = booking.address || '';
            document.getElementById('quoteClientEmail').value = booking.email || '';
            document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];

            // Create initial service item with booking service
            const initialServiceItem = {
                description: booking.service || 'Tree Service',
                quantity: 1,
                price: 0,
                total: 0
            };

            // Load service items (this will clear container and recreate)
            loadServiceItems([initialServiceItem]);

            // Reset tax toggle
            document.getElementById('taxToggle').checked = false;

            // Show modal
            openModal('quoteModal');
        }

        // Load service items from saved quote
        function loadServiceItems(serviceItems) {
            const container = document.querySelector('.service-items-container');
            
            // Clear existing items
            container.innerHTML = '';
            itemCounter = 0;

            if (serviceItems.length === 0) {
                // Add one empty item if no items exist
                addServiceItem();
                return;
            }

            // Load each service item
            serviceItems.forEach((item, index) => {
                itemCounter++;
                const newItem = document.createElement('div');
                newItem.className = 'service-item';
                newItem.setAttribute('data-item-id', itemCounter);

                newItem.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description || ''}" placeholder="Service description">
                        </div>
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="${item.quantity || 1}" min="1">
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="${item.price || ''}" min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div class="item-total">
                            <span class="item-total-amount">$${((item.quantity || 1) * (item.price || 0)).toFixed(2)}</span>
                        </div>
                        <div class="item-actions">
                            <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(newItem);
                setupItemEventListeners(newItem);
            });

            // Force update totals after loading all items
            setTimeout(() => {
                updateQuoteTotals();
            }, 100);
        }

        // Add Service Item
        function addServiceItem() {
            itemCounter++;
            const container = document.querySelector('.service-items-container');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.setAttribute('data-item-id', itemCounter);

            newItem.innerHTML = `
                <div class="item-row">
                    <div class="item-description">
                        <input type="text" class="item-desc-input" placeholder="Service description">
                    </div>
                    <div class="item-quantity">
                        <input type="number" class="item-qty-input" value="1" min="1">
                    </div>
                    <div class="item-price">
                        <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="item-total">
                        <span class="item-total-amount">$0.00</span>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(newItem);
            setupItemEventListeners(newItem);
        }

        // Remove Service Item
        function removeServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('.service-item').length > 1) {
                serviceItem.remove();
                updateQuoteTotals();
            } else {
                showNotification('At least one service item is required', 'warning');
            }
        }

        // Setup Event Listeners for Service Items
        function setupItemEventListeners(item) {
            const qtyInput = item.querySelector('.item-qty-input');
            const priceInput = item.querySelector('.item-price-input');

            // Remove existing listeners to prevent duplicates
            qtyInput.removeEventListener('input', updateItemTotal);
            priceInput.removeEventListener('input', updateItemTotal);

            qtyInput.addEventListener('input', updateItemTotal);
            priceInput.addEventListener('input', updateItemTotal);

            function updateItemTotal() {
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = qty * price;
                const totalSpan = item.querySelector('.item-total-amount');
                totalSpan.textContent = `$${total.toFixed(2)}`;
                updateQuoteTotals();
            }

            // Initialize the total for this item
            updateItemTotal();
        }

        // Update Quote Totals
        function updateQuoteTotals() {
            let subtotal = 0;
            const items = document.querySelectorAll('.service-item');

            items.forEach(item => {
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                // Handle empty values properly
                const qty = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                
                subtotal += qty * price;
            });

            const taxToggle = document.getElementById('taxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            // Format numbers with proper decimal places
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('taxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';
        }

        // Toggle Tax
        function toggleTax() {
            updateQuoteTotals();
        }

        // Setup initial event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup event listeners for existing service items
            document.querySelectorAll('.service-item').forEach(setupItemEventListeners);

            // Setup event listeners for form inputs
            document.querySelectorAll('.item-qty-input, .item-price-input').forEach(input => {
                input.addEventListener('input', updateQuoteTotals);
            });
        });

        // Save Quote to Database
        function generateQuote() {
            // Validate form
            const requiredFields = ['quoteClientName', 'quoteClientPhone', 'quoteClientAddress', 'quoteClientEmail', 'quoteDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Collect service items
            const serviceItems = [];
            document.querySelectorAll('.service-item').forEach((item, index) => {
                const description = item.querySelector('.item-desc-input').value.trim();
                const qtyInput = item.querySelector('.item-qty-input');
                const priceInput = item.querySelector('.item-price-input');
                
                const quantity = qtyInput.value.trim() === '' ? 0 : parseFloat(qtyInput.value) || 0;
                const price = priceInput.value.trim() === '' ? 0 : parseFloat(priceInput.value) || 0;
                const total = quantity * price;

                // Save all items with a description, even if price is 0
                if (description && quantity > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('Please add at least one service item with a description', 'error');
                return;
            }

            // Save quote to database
            saveQuote(serviceItems);
        }

        // Save Quote to Database
        async function saveQuote(serviceItems) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteData = {
                booking_id: currentQuoteData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                quote_date: quoteDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            try {
                // If we have an existing quote ID, update it; otherwise create new
                const method = currentQuoteData.quoteId ? 'PUT' : 'POST';
                const url = currentQuoteData.quoteId ? `/api/quotes/${currentQuoteData.quoteId}` : '/api/quotes';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Quote saved successfully!', 'success');
                    
                    // Store the quote ID for later use
                    currentQuoteData.quoteId = result.quote_id;
                    
                    // Generate quote preview
                    generateQuotePreview(serviceItems, result.quote_id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save quote', 'error');
                }
            } catch (error) {
                console.error('Error saving quote:', error);
                showNotification('Network error saving quote', 'error');
            }
        }

        // Generate Quote Preview
        function generateQuotePreview(serviceItems, quoteId = null) {
            const clientName = document.getElementById('quoteClientName').value;
            const clientPhone = document.getElementById('quoteClientPhone').value;
            const clientAddress = document.getElementById('quoteClientAddress').value;
            const clientEmail = document.getElementById('quoteClientEmail').value;
            const quoteDate = document.getElementById('quoteDate').value;
            const taxEnabled = document.getElementById('taxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const quoteNumber = quoteId || generateQuoteNumber();
            const formattedDate = new Date(quoteDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const quoteHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>123 Business Street, Toronto, ON M5V 3A8</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(555) 123-4567</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>info@stellartreemanagement.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">QUOTE</div>
                            <div class="document-number">#${quoteNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Terms & Conditions</h3>
                        <div class="terms-content">
                            <p>All estimates are valid for 60 days after the estimate has been delivered. Payment is due upon completion of work unless otherwise agreed upon. We accept cash, check, and major credit cards.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('quotePreviewContent').innerHTML = quoteHTML;
            closeModal('quoteModal');
            openModal('quotePreviewModal');
        }

        // Generate Quote Number
        function generateQuoteNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `QT-${year}${month}${day}-${random}`;
        }

        // Print Quote
        function printQuote() {
            const printWindow = window.open('', '_blank');
            const quoteContent = document.getElementById('quotePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quote - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0; 
                            padding: 40px; 
                            background: #fff;
                            color: #333;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .quote-document { 
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        /* Header Section */
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #8cc63f;
                        }
                        .company-brand { display: flex; align-items: center; gap: 16px; }
                        .company-logo { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; }
                        .company-name { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            letter-spacing: 0.3px;
                        }
                        .company-contact { margin-top: 10px; }
                        .contact-item { 
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                            margin-bottom: 5px;
                            font-size: 11px;
                            color: #666;
                        }
                        .contact-item i { 
                            width: 12px; 
                            color: #8cc63f;
                            text-align: center;
                        }
                        .document-info { 
                            text-align: right;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }
                        .document-type { 
                            font-size: 22px; 
                            font-weight: 800; 
                            color: #2c3e50;
                            margin-bottom: 8px;
                            letter-spacing: 1.2px;
                        }
                        .document-number { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin-bottom: 6px;
                            color: #555;
                        }
                        .document-date { 
                            font-size: 12px; 
                            color: #666;
                        }
                        
                        /* Client & Billing Section */
                        .client-billing-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 24px; 
                            padding: 24px;
                            background: #f8f9fa;
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            margin: 24px;
                        }
                        .section-heading { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin: 0 0 12px 0;
                            color: #2c3e50;
                            border-bottom: 2px solid #8cc63f;
                            padding-bottom: 6px;
                        }
                        .data-row { 
                            display: flex; 
                            margin-bottom: 8px;
                            align-items: flex-start;
                            min-height: 16px;
                        }
                        .label { 
                            font-weight: 600; 
                            min-width: 70px;
                            color: #555;
                            font-size: 11px;
                            flex-shrink: 0;
                        }
                        .value { 
                            flex: 1;
                            color: #333;
                            font-size: 11px;
                            word-wrap: break-word;
                        }
                        
                        /* Services Section */
                        .services-section { padding: 24px; }
                        .services-table { 
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 12px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .table-header { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            background: #2c3e50;
                            color: white;
                            font-weight: 600;
                            font-size: 11px;
                        }
                        .header-item { 
                            padding: 12px 10px;
                            text-align: left;
                            border-right: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        .header-item:last-child { border-right: none; }
                        .table-body { background: white; }
                        .table-row { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            border-bottom: 1px solid #e1e8ed;
                            font-size: 11px;
                            min-height: 40px;
                        }
                        .table-row:nth-child(even) { background: #f8f9fa; }
                        .table-row:last-child { border-bottom: none; }
                        .table-cell { 
                            padding: 12px 10px;
                            display: flex;
                            align-items: center;
                            border-right: 1px solid #e1e8ed;
                        }
                        .table-cell:last-child { border-right: none; }
                        .table-cell.description { font-weight: 500; }
                        .table-cell.quantity { justify-content: center; }
                        .table-cell.price, .table-cell.total { 
                            justify-content: flex-end;
                            font-weight: 600;
                        }
                        
                        /* Totals Section */
                        .totals-section { 
                            padding: 0 24px 24px;
                            display: flex;
                            justify-content: flex-end;
                        }
                        .totals-container { 
                            width: 240px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border: 1px solid #e1e8ed;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-size: 12px;
                            align-items: center;
                            min-height: 20px;
                        }
                        .total-row.grand-total { 
                            border-top: 2px solid #8cc63f;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-size: 15px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        .total-label { font-weight: 600; }
                        .total-value { font-weight: 600; }
                        
                        /* Terms Section */
                        .terms-section { 
                            padding: 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #e1e8ed;
                        }
                        .terms-content p { 
                            margin: 0;
                            font-size: 10px;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${quoteContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Quote as PDF
        function downloadQuotePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printQuote();
        }

        // Invoice Functions
        let currentInvoiceData = null;

        // Show Invoice Modal
        function showInvoiceModal(quote, booking) {
            currentInvoiceData = {
                quoteId: quote.quote_id,
                bookingId: booking.booking_id,
                service: booking.service,
                date: booking.date,
                time: booking.time,
                name: booking.name,
                email: booking.email,
                phone: booking.phone,
                address: booking.address,
                notes: booking.notes
            };

            // Pre-fill client information from quote
            document.getElementById('invoiceClientName').value = quote.client_name || booking.name || '';
            document.getElementById('invoiceClientPhone').value = quote.client_phone || booking.phone || '';
            document.getElementById('invoiceClientAddress').value = quote.client_address || booking.address || '';
            document.getElementById('invoiceClientEmail').value = quote.client_email || booking.email || '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Populate service items from quote
            populateInvoiceServiceItems(quote.service_items);

            // Set tax toggle
            document.getElementById('invoiceTaxToggle').checked = quote.tax_enabled || false;

            // Update totals
            updateInvoiceTotals();

            // Show modal
            openModal('invoiceModal');
        }

        // Populate Invoice Service Items
        function populateInvoiceServiceItems(serviceItems) {
            const container = document.getElementById('invoiceServiceItems');
            container.innerHTML = '';

            serviceItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'service-item';
                itemDiv.setAttribute('data-item-id', index + 1);

                itemDiv.innerHTML = `
                    <div class="item-row">
                        <div class="item-description">
                            <input type="text" class="item-desc-input" value="${item.description}" readonly>
                        </div>
                        <div class="item-quantity">
                            <input type="number" class="item-qty-input" value="${item.quantity}" min="1" readonly>
                        </div>
                        <div class="item-price">
                            <input type="number" class="item-price-input" value="${item.price}" min="0" step="0.01" readonly>
                        </div>
                        <div class="item-total">
                            <span class="item-total-amount">$${item.total.toFixed(2)}</span>
                        </div>
                        <div class="item-actions">
                            <!-- No remove button for invoices -->
                        </div>
                    </div>
                `;

                container.appendChild(itemDiv);
            });
        }

        // Update Invoice Totals
        function updateInvoiceTotals() {
            const items = document.querySelectorAll('#invoiceServiceItems .service-item');
            let subtotal = 0;

            items.forEach(item => {
                const qty = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                subtotal += qty * price;
            });

            const taxToggle = document.getElementById('invoiceTaxToggle');
            const taxRate = 0.05; // 5%
            const tax = taxToggle.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;

            document.getElementById('invoiceSubtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('invoiceTaxAmount').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('invoiceGrandTotalAmount').textContent = `$${total.toFixed(2)}`;

            // Show/hide tax row
            const taxRow = document.getElementById('invoiceTaxRow');
            taxRow.style.display = taxToggle.checked ? 'flex' : 'none';
        }

        // Toggle Invoice Tax
        function toggleInvoiceTax() {
            updateInvoiceTotals();
        }

        // Create Invoice from Saved Quote
        function generateInvoice() {
            // Validate form
            const requiredFields = ['invoiceClientName', 'invoiceClientPhone', 'invoiceClientAddress', 'invoiceClientEmail', 'invoiceDate'];
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showNotification(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return;
                }
            }

            // Collect service items
            const serviceItems = [];
            document.querySelectorAll('#invoiceServiceItems .service-item').forEach(item => {
                const description = item.querySelector('.item-desc-input').value;
                const quantity = parseFloat(item.querySelector('.item-qty-input').value) || 0;
                const price = parseFloat(item.querySelector('.item-price-input').value) || 0;
                const total = quantity * price;

                if (description && quantity > 0 && price > 0) {
                    serviceItems.push({
                        description,
                        quantity,
                        price,
                        total
                    });
                }
            });

            if (serviceItems.length === 0) {
                showNotification('No service items found', 'error');
                return;
            }

            // Save invoice to database
            saveInvoice(serviceItems);
        }

        // Save Invoice to Database
        async function saveInvoice(serviceItems) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const invoiceData = {
                quote_id: currentInvoiceData.quoteId,
                booking_id: currentInvoiceData.bookingId,
                client_name: clientName,
                client_phone: clientPhone,
                client_address: clientAddress,
                client_email: clientEmail,
                invoice_date: invoiceDate,
                service_items: serviceItems,
                subtotal: subtotal,
                tax_amount: tax,
                total_amount: total,
                tax_enabled: taxEnabled
            };

            try {
                const response = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Invoice created successfully!', 'success');
                    
                    // Store the invoice ID for later use
                    currentInvoiceData.invoiceId = result.invoice_id;
                    
                    // Generate invoice preview
                    generateInvoicePreview(serviceItems, result.invoice_id);
                    
                    // Complete the booking
                    await completeBookingWithInvoice();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to create invoice', 'error');
                }
            } catch (error) {
                console.error('Error creating invoice:', error);
                showNotification('Network error creating invoice', 'error');
            }
        }

        // Complete Booking with Invoice
        async function completeBookingWithInvoice() {
            try {
                const response = await fetch(`/api/bookings/${currentInvoiceData.bookingId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    showNotification('Booking completed successfully!', 'success');
                    loadBookings(); // Reload to update the display
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to complete booking', 'error');
                }
            } catch (error) {
                console.error('Error completing booking:', error);
                showNotification('Network error completing booking', 'error');
            }
        }

        // Generate Invoice Preview
        function generateInvoicePreview(serviceItems, invoiceId = null) {
            const clientName = document.getElementById('invoiceClientName').value;
            const clientPhone = document.getElementById('invoiceClientPhone').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const clientEmail = document.getElementById('invoiceClientEmail').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxEnabled = document.getElementById('invoiceTaxToggle').checked;

            const subtotal = serviceItems.reduce((sum, item) => sum + item.total, 0);
            const tax = taxEnabled ? subtotal * 0.05 : 0;
            const total = subtotal + tax;

            const invoiceNumber = invoiceId || generateInvoiceNumber();
            const formattedDate = new Date(invoiceDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const invoiceHTML = `
                <div class="quote-document">
                    <!-- Header Section -->
                    <div class="quote-header">
                        <div class="company-brand">
                            <img src="images/logo.png" alt="Stellar Tree Management" class="company-logo">
                            <div>
                                <h1 class="company-name">Stellar Tree Management</h1>
                                <div class="company-contact">
                                    <div class="contact-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>123 Business Street, Toronto, ON M5V 3A8</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-phone"></i>
                                        <span>(555) 123-4567</span>
                                    </div>
                                    <div class="contact-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>info@stellartreemanagement.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="document-info">
                            <div class="document-type">INVOICE</div>
                            <div class="document-number">#${invoiceNumber}</div>
                            <div class="document-date">${formattedDate}</div>
                        </div>
                    </div>

                    <!-- Client & Bill To Section -->
                    <div class="client-billing-section">
                        <div>
                            <h3 class="section-heading">Client Information</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Phone:</span>
                                <span class="value">${clientPhone}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Email:</span>
                                <span class="value">${clientEmail}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="section-heading">Bill To</h3>
                            <div class="data-row">
                                <span class="label">Name:</span>
                                <span class="value">${clientName}</span>
                            </div>
                            <div class="data-row">
                                <span class="label">Address:</span>
                                <span class="value">${clientAddress}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="services-section">
                        <h3 class="section-heading">Services</h3>
                        <div class="services-table">
                            <div class="table-header">
                                <div class="header-item">#</div>
                                <div class="header-item description">Description</div>
                                <div class="header-item quantity">Qty</div>
                                <div class="header-item price">Unit Price</div>
                                <div class="header-item total">Total</div>
                            </div>
                            <div class="table-body">
                                ${serviceItems.map((item, index) => `
                                    <div class="table-row">
                                        <div class="table-cell">${index + 1}</div>
                                        <div class="table-cell description">${item.description}</div>
                                        <div class="table-cell quantity">${item.quantity}</div>
                                        <div class="table-cell price">$${item.price.toFixed(2)}</div>
                                        <div class="table-cell total">$${item.total.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="totals-container">
                            <div class="total-row">
                                <span class="total-label">Subtotal:</span>
                                <span class="total-value">$${subtotal.toFixed(2)}</span>
                            </div>
                            ${taxEnabled ? `
                                <div class="total-row">
                                    <span class="total-label">Tax (5%):</span>
                                    <span class="total-value">$${tax.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span class="total-label">Total:</span>
                                <span class="total-value">$${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h3 class="section-heading">Payment Terms</h3>
                        <div class="terms-content">
                            <p>Payment is due upon receipt of this invoice. We accept cash, check, and major credit cards. Please include the invoice number with your payment.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('invoicePreviewContent').innerHTML = invoiceHTML;
            closeModal('invoiceModal');
            openModal('invoicePreviewModal');
        }

        // Generate Invoice Number
        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `INV-${year}${month}${day}-${random}`;
        }

        // Print Invoice
        function printInvoice() {
            const printWindow = window.open('', '_blank');
            const invoiceContent = document.getElementById('invoicePreviewContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice - Stellar Tree Management</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0; 
                            padding: 40px; 
                            background: #fff;
                            color: #333;
                            line-height: 1.4;
                            font-size: 12px;
                        }
                        .quote-document { 
                            max-width: 800px; 
                            margin: 0 auto; 
                            background: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        /* Header Section */
                        .quote-header { 
                            background: white;
                            color: #333;
                            padding: 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 3px solid #8cc63f;
                        }
                        .company-brand { display: flex; align-items: center; gap: 16px; }
                        .company-logo { width: 48px; height: 48px; object-fit: contain; border-radius: 4px; }
                        .company-name { 
                            font-size: 20px; 
                            font-weight: 700; 
                            color: #2c3e50;
                            margin: 0 0 10px 0;
                            letter-spacing: 0.3px;
                        }
                        .company-contact { margin-top: 10px; }
                        .contact-item { 
                            display: flex; 
                            align-items: center; 
                            gap: 8px; 
                            margin-bottom: 5px;
                            font-size: 11px;
                            color: #666;
                        }
                        .contact-item i { 
                            width: 12px; 
                            color: #8cc63f;
                            text-align: center;
                        }
                        .document-info { 
                            text-align: right;
                            display: flex;
                            flex-direction: column;
                            align-items: flex-end;
                        }
                        .document-type { 
                            font-size: 22px; 
                            font-weight: 800; 
                            color: #2c3e50;
                            margin-bottom: 8px;
                            letter-spacing: 1.2px;
                        }
                        .document-number { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin-bottom: 6px;
                            color: #555;
                        }
                        .document-date { 
                            font-size: 12px; 
                            color: #666;
                        }
                        
                        /* Client & Billing Section */
                        .client-billing-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 24px; 
                            padding: 24px;
                            background: #f8f9fa;
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            margin: 24px;
                        }
                        .section-heading { 
                            font-size: 15px; 
                            font-weight: 600; 
                            margin: 0 0 12px 0;
                            color: #2c3e50;
                            border-bottom: 2px solid #8cc63f;
                            padding-bottom: 6px;
                        }
                        .data-row { 
                            display: flex; 
                            margin-bottom: 8px;
                            align-items: flex-start;
                            min-height: 16px;
                        }
                        .label { 
                            font-weight: 600; 
                            min-width: 70px;
                            color: #555;
                            font-size: 11px;
                            flex-shrink: 0;
                        }
                        .value { 
                            flex: 1;
                            color: #333;
                            font-size: 11px;
                            word-wrap: break-word;
                        }
                        
                        /* Services Section */
                        .services-section { padding: 24px; }
                        .services-table { 
                            border: 1px solid #e1e8ed;
                            border-radius: 8px;
                            overflow: hidden;
                            margin-top: 12px;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .table-header { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            background: #2c3e50;
                            color: white;
                            font-weight: 600;
                            font-size: 11px;
                        }
                        .header-item { 
                            padding: 12px 10px;
                            text-align: left;
                            border-right: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        .header-item:last-child { border-right: none; }
                        .table-body { background: white; }
                        .table-row { 
                            display: grid;
                            grid-template-columns: 40px 1fr 60px 90px 90px;
                            border-bottom: 1px solid #e1e8ed;
                            font-size: 11px;
                            min-height: 40px;
                        }
                        .table-row:nth-child(even) { background: #f8f9fa; }
                        .table-row:last-child { border-bottom: none; }
                        .table-cell { 
                            padding: 12px 10px;
                            display: flex;
                            align-items: center;
                            border-right: 1px solid #e1e8ed;
                        }
                        .table-cell:last-child { border-right: none; }
                        .table-cell.description { font-weight: 500; }
                        .table-cell.quantity { justify-content: center; }
                        .table-cell.price, .table-cell.total { 
                            justify-content: flex-end;
                            font-weight: 600;
                        }
                        
                        /* Totals Section */
                        .totals-section { 
                            padding: 0 24px 24px;
                            display: flex;
                            justify-content: flex-end;
                        }
                        .totals-container { 
                            width: 240px;
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 16px;
                            border: 1px solid #e1e8ed;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                        .total-row { 
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-size: 12px;
                            align-items: center;
                            min-height: 20px;
                        }
                        .total-row.grand-total { 
                            border-top: 2px solid #8cc63f;
                            padding-top: 10px;
                            margin-top: 10px;
                            font-size: 15px;
                            font-weight: 700;
                            color: #2c3e50;
                        }
                        .total-label { font-weight: 600; }
                        .total-value { font-weight: 600; }
                        
                        /* Terms Section */
                        .terms-section { 
                            padding: 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #e1e8ed;
                        }
                        .terms-content p { 
                            margin: 0;
                            font-size: 10px;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                            }
                            .quote-document { 
                                box-shadow: none;
                                border-radius: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Download Invoice as PDF
        function downloadInvoicePDF() {
            // For now, we'll use the print function as a fallback
            // In a production environment, you'd want to use a proper PDF library like jsPDF
            showNotification('PDF download feature coming soon. Use print function for now.', 'info');
            printInvoice();
        }

        // Customer Management Functions

        // Recalculate all customer totals
        async function recalculateCustomerTotals() {
            if (!confirm('This will recalculate the total spent for all customers. This may take a moment. Continue?')) {
                return;
            }
            
            try {
                showNotification('Recalculating customer totals...', 'info');
                
                const response = await fetch('/api/customers/recalculate-totals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    
                    // Reload customers to show updated totals
                    await loadCustomers();
                } else {
                    showNotification('Failed to recalculate totals', 'error');
                }
            } catch (error) {
                console.error('Error recalculating totals:', error);
                showNotification('Network error during recalculation', 'error');
            }
        }

        // Refresh customer data
        async function refreshCustomerData() {
            try {
                showNotification('Refreshing customer data...', 'info');
                await loadCustomers();
                showNotification('Customer data refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing customer data:', error);
                showNotification('Network error refreshing customer data', 'error');
            }
        }

        // Recalculate specific customer total
        async function recalculateCustomerTotal(customerId) {
            try {
                showNotification('Recalculating customer total...', 'info');
                
                const response = await fetch(`/api/customers/${customerId}/recalculate-total`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    
                    // Refresh the customer details view
                    await showCustomerDetails(customerId);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to recalculate customer total', 'error');
                }
            } catch (error) {
                console.error('Error recalculating customer total:', error);
                showNotification('Network error recalculating customer total', 'error');
            }
        }

        // Load customers from API
        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                if (response.ok) {
                    allCustomers = await response.json();
                    renderCustomers();
                } else {
                    showNotification('Failed to load customers', 'error');
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showNotification('Network error loading customers', 'error');
            }
        }

        // Render customers grid
        function renderCustomers() {
            const grid = document.getElementById('customersGrid');
            
            if (allCustomers.length === 0) {
                grid.innerHTML = '<div class="empty-state">No customers found</div>';
                return;
            }

            grid.innerHTML = allCustomers.map(customer => {
                return `
                    <div class="customer-card" onclick="showCustomerDetails('${customer.customer_id}')">
                        <div class="customer-header">
                            <div>
                                <div class="customer-name">${customer.name}</div>
                                <div class="customer-id">${customer.customer_id}</div>
                            </div>
                        </div>
                        <div class="customer-contact">
                            <div class="contact-item">
                                <i class="fas fa-envelope"></i>
                                <span class="contact-label">Email:</span>
                                <span class="contact-value">${customer.email}</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span class="contact-label">Phone:</span>
                                <span class="contact-value">${customer.phone}</span>
                            </div>
                            ${customer.address ? `
                                <div class="contact-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span class="contact-label">Address:</span>
                                    <span class="contact-value">${customer.address}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="customer-stats">
                            <div class="stat-item">
                                <div class="stat-number">${customer.total_bookings || 0}</div>
                                <div class="stat-label">Bookings</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">$${(customer.total_spent || 0).toFixed(2)}</div>
                                <div class="stat-label">Total Spent</div>
                            </div>
                        </div>
                        <div class="customer-actions-card" onclick="event.stopPropagation();">
                            <button class="customer-action-btn view" onclick="showCustomerDetails('${customer.customer_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="customer-action-btn edit" onclick="editCustomer('${customer.customer_id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="customer-action-btn delete" onclick="deleteCustomer('${customer.customer_id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Search customers
        async function searchCustomers() {
            const query = document.getElementById('customerSearchInput').value.trim();
            
            if (!query) {
                loadCustomers();
                return;
            }

            try {
                const response = await fetch(`/api/customers/search/${encodeURIComponent(query)}`);
                if (response.ok) {
                    allCustomers = await response.json();
                    renderCustomers();
                } else {
                    showNotification('Failed to search customers', 'error');
                }
            } catch (error) {
                console.error('Error searching customers:', error);
                showNotification('Network error searching customers', 'error');
            }
        }

        // Show add customer modal
        function showAddCustomerModal() {
            currentCustomerId = null;
            document.getElementById('customerModalTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            openModal('customerModal');
        }

        // Show customer details
        async function showCustomerDetails(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}`);
                if (response.ok) {
                    const data = await response.json();
                    renderCustomerDetails(data);
                    openModal('customerDetailsModal');
                } else {
                    showNotification('Failed to load customer details', 'error');
                }
            } catch (error) {
                console.error('Error loading customer details:', error);
                showNotification('Network error loading customer details', 'error');
            }
        }

        // Render customer details
        function renderCustomerDetails(data) {
            const { customer, bookings, quotes, invoices, totalBreakdown } = data;
            
            document.getElementById('customerDetailsTitle').textContent = `Customer Details - ${customer.name}`;
            
            const content = `
                <div class="customer-details-grid">
                    <div class="customer-info-section">
                        <h4><i class="fas fa-user"></i> Customer Information</h4>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${customer.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${customer.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${customer.phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address:</span>
                            <span class="info-value">${customer.address || 'Not provided'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Customer ID:</span>
                            <span class="info-value">${customer.customer_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Created:</span>
                            <span class="info-value">${new Date(customer.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Bookings:</span>
                            <span class="info-value">${customer.total_bookings || 0}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Spent:</span>
                            <span class="info-value">$${(customer.total_spent || 0).toFixed(2)}</span>
                            <button class="action-btn info" onclick="recalculateCustomerTotal('${customer.customer_id}')" style="margin-left: 10px; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                <i class="fas fa-calculator"></i> Recalculate
                            </button>
                        </div>

                        ${customer.notes ? `
                            <div class="info-row">
                                <span class="info-label">Notes:</span>
                                <span class="info-value">${customer.notes}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="customer-history-section">
                        <div class="history-tabs">
                            <div class="history-tab active" onclick="switchHistoryTab('bookings', {bookings, quotes, invoices})">Bookings (${bookings.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('quotes', {bookings, quotes, invoices})">Quotes (${quotes.length})</div>
                            <div class="history-tab" onclick="switchHistoryTab('invoices', {bookings, quotes, invoices})">Invoices (${invoices.length})</div>
                        </div>
                        <div class="history-content" id="historyContent">
                            ${renderEnhancedHistoryTab('bookings', bookings, quotes, invoices)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsContent').innerHTML = content;
        }

        // Switch history tab
        function switchHistoryTab(tab, data) {
            // Update active tab
            document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Get data based on tab
            let items = [];
            if (tab === 'bookings') items = data.bookings || [];
            else if (tab === 'quotes') items = data.quotes || [];
            else if (tab === 'invoices') items = data.invoices || [];
            
            if (tab === 'bookings') {
                document.getElementById('historyContent').innerHTML = renderEnhancedHistoryTab(tab, data.bookings || [], data.quotes || [], data.invoices || []);
            } else {
                document.getElementById('historyContent').innerHTML = renderHistoryTab(tab, items);
            }
        }

        // Render enhanced history tab content for bookings with related invoices and quotes
        function renderEnhancedHistoryTab(tab, bookings, quotes, invoices) {
            if (bookings.length === 0) {
                return '<div class="empty-state">No bookings found</div>';
            }

            return bookings.map(booking => {
                // Find related quotes and invoices for this booking
                const relatedQuotes = quotes.filter(q => q.booking_id === booking.booking_id);
                const relatedInvoices = invoices.filter(i => i.booking_id === booking.booking_id);
                
                return `
                    <div class="enhanced-history-item">
                        <div class="booking-header">
                            <h5><i class="fas fa-calendar-check"></i> ${booking.service} - ${booking.status}</h5>
                            <div class="booking-meta">
                                <span class="booking-date"><i class="fas fa-calendar"></i> ${new Date(booking.date).toLocaleDateString()} at ${booking.time}</span>
                                <span class="booking-id"><i class="fas fa-hashtag"></i> ${booking.booking_id}</span>
                            </div>
                        </div>
                        
                        <div class="booking-details">
                            <div class="detail-row">
                                <span class="detail-label">Customer:</span>
                                <span class="detail-value">${booking.name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${booking.notes || 'No notes'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Created:</span>
                                <span class="detail-value">${new Date(booking.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        
                        ${relatedQuotes.length > 0 || relatedInvoices.length > 0 ? `
                            <div class="related-documents">
                                ${relatedQuotes.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-file-invoice-dollar"></i> Related Quotes (${relatedQuotes.length})</h6>
                                        <div class="document-list">
                                            ${relatedQuotes.map(quote => {
                                                const serviceItems = JSON.parse(quote.service_items);
                                                return `
                                                    <div class="document-item quote-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Quote ${quote.quote_id}</span>
                                                            <span class="document-status ${quote.status}">${quote.status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${quote.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(quote.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${relatedInvoices.length > 0 ? `
                                    <div class="document-section">
                                        <h6><i class="fas fa-receipt"></i> Related Invoices (${relatedInvoices.length})</h6>
                                        <div class="document-list">
                                            ${relatedInvoices.map(invoice => {
                                                const serviceItems = JSON.parse(invoice.service_items);
                                                return `
                                                    <div class="document-item invoice-item">
                                                        <div class="document-header">
                                                            <span class="document-id">Invoice ${invoice.invoice_id}</span>
                                                            <span class="document-status ${invoice.payment_status}">${invoice.payment_status}</span>
                                                        </div>
                                                        <div class="document-details">
                                                            <span class="document-amount">$${invoice.total_amount}</span>
                                                            <span class="document-services">${serviceItems.map(s => s.description).join(', ')}</span>
                                                        </div>
                                                        <div class="document-date">${new Date(invoice.created_at).toLocaleDateString()}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="no-documents">
                                <i class="fas fa-info-circle"></i> No related quotes or invoices found for this booking.
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // Render history tab content
        function renderHistoryTab(tab, items) {
            if (items.length === 0) {
                return '<div class="empty-state">No items found</div>';
            }

            return items.map(item => {
                if (tab === 'bookings') {
                    return `
                        <div class="history-item">
                            <h5>${item.service} - ${item.status}</h5>
                            <p><strong>Date:</strong> ${new Date(item.date).toLocaleDateString()} at ${item.time}</p>
                            <p><strong>Booking ID:</strong> ${item.booking_id}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'quotes') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Quote ${item.quote_id} - ${item.status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                } else if (tab === 'invoices') {
                    const serviceItems = JSON.parse(item.service_items);
                    return `
                        <div class="history-item">
                            <h5>Invoice ${item.invoice_id} - ${item.payment_status}</h5>
                            <p><strong>Total:</strong> $${item.total_amount}</p>
                            <p><strong>Services:</strong> ${serviceItems.map(s => s.description).join(', ')}</p>
                            <p class="date">Created: ${new Date(item.created_at).toLocaleDateString()}</p>
                        </div>
                    `;
                }
            }).join('');
        }

        // Edit customer
        function editCustomer(customerId) {
            currentCustomerId = customerId;
            const customer = allCustomers.find(c => c.customer_id === customerId);
            
            if (customer) {
                document.getElementById('customerModalTitle').textContent = 'Edit Customer';
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerAddress').value = customer.address || '';
                document.getElementById('customerNotes').value = customer.notes || '';
                openModal('customerModal');
            }
        }

        // Save customer
        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();

            if (!name || !email || !phone) {
                showNotification('Name, email, and phone are required', 'error');
                return;
            }

            try {
                const url = currentCustomerId ? `/api/customers/${currentCustomerId}` : '/api/customers';
                const method = currentCustomerId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, phone, address, notes })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    closeCustomerModal();
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save customer', 'error');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showNotification('Network error saving customer', 'error');
            }
        }

        // Delete customer
        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    
                    // Check if customer has associated data and offer force delete
                    if (error.hasData) {
                        const forceDelete = confirm(
                            `This customer has associated data:\n` +
                            `- ${error.counts.booking_count} bookings\n` +
                            `- ${error.counts.quote_count} quotes\n` +
                            `- ${error.counts.invoice_count} invoices\n\n` +
                            `Do you want to force delete this customer and ALL associated data? This action cannot be undone.`
                        );
                        
                        if (forceDelete) {
                            try {
                                const forceResponse = await fetch(`/api/customers/${customerId}?force=true`, {
                                    method: 'DELETE'
                                });
                                
                                if (forceResponse.ok) {
                                    const forceResult = await forceResponse.json();
                                    showNotification(forceResult.message, 'success');
                                    loadCustomers();
                                } else {
                                    const forceError = await forceResponse.json();
                                    showNotification(forceError.error || 'Failed to force delete customer', 'error');
                                }
                            } catch (forceError) {
                                console.error('Error force deleting customer:', forceError);
                                showNotification('Network error force deleting customer', 'error');
                            }
                        }
                    } else {
                        showNotification(error.error || 'Failed to delete customer', 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                showNotification('Network error deleting customer', 'error');
            }
        }

        // Migrate existing customers
        async function migrateCustomers() {
            if (!confirm('This will migrate existing bookings to create customer profiles. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/customers/migrate', {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Migration completed: ${result.processed} customers processed, ${result.errors} errors`, 'success');
                    loadCustomers();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to migrate customers', 'error');
                }
            } catch (error) {
                console.error('Error migrating customers:', error);
                showNotification('Network error migrating customers', 'error');
            }
        }

        // Close customer modal
        function closeCustomerModal() {
            closeModal('customerModal');
            currentCustomerId = null;
        }

        // Close customer details modal
        function closeCustomerDetailsModal() {
            closeModal('customerDetailsModal');
        }

        // Image Modal Functions
        function showImageModal(imagePath) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imagePath;
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        // Smooth filter tab click handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-tab')) {
                const filter = e.target.getAttribute('data-filter');
                
                // Prevent multiple rapid clicks
                if (e.target.classList.contains('loading')) return;
                
                // Add loading state to clicked tab
                e.target.classList.add('loading');
                
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.classList.remove('loading');
                });
                e.target.classList.add('active');
                
                // Update section title smoothly
                const sectionTitle = document.getElementById('sectionTitle');
                let newTitle = '';
                if (filter === 'all') newTitle = 'Active Bookings';
                else if (filter === 'pending') newTitle = 'Pending Bookings';
                else if (filter === 'confirmed') newTitle = 'Confirmed Bookings';
                else if (filter === 'all-bookings') newTitle = 'All Bookings';
                else if (filter === 'calendar') newTitle = 'Calendar View';
                else if (filter === 'customers') newTitle = 'Customer Management';
                
                // Smooth title transition
                sectionTitle.style.opacity = '0';
                sectionTitle.style.transform = 'translateY(-5px)';
                
                // Hide all views smoothly first
                const views = ['activeBookingsGrid', 'calendarView', 'customerView'];
                views.forEach(viewId => {
                    const view = document.getElementById(viewId);
                    view.classList.add('view-hidden');
                });
                
                // Wait for fade out, then show new view
                setTimeout(() => {
                    // Update title
                    sectionTitle.textContent = newTitle;
                    sectionTitle.style.opacity = '1';
                    sectionTitle.style.transform = 'translateY(0)';
                    
                    // Hide all views
                    views.forEach(viewId => {
                        const view = document.getElementById(viewId);
                        view.style.display = 'none';
                        view.classList.remove('view-hidden');
                    });
                    
                    // Show appropriate view
                    let targetView;
                    if (filter === 'calendar') {
                        targetView = document.getElementById('calendarView');
                        targetView.style.display = 'block';
                        if (!blockedDates.length) loadBlockedDates();
                        renderCalendar();
                    } else if (filter === 'customers') {
                        targetView = document.getElementById('customerView');
                        targetView.style.display = 'block';
                        loadCustomers();
                    } else {
                        targetView = document.getElementById('activeBookingsGrid');
                        targetView.style.display = 'grid';
                        currentFilter = filter;
                        renderActiveBookings();
                    }
                    
                    // Trigger smooth entrance animation
                    requestAnimationFrame(() => {
                        targetView.style.opacity = '0';
                        targetView.style.transform = 'translateY(10px)';
                        requestAnimationFrame(() => {
                            targetView.style.opacity = '1';
                            targetView.style.transform = 'translateY(0)';
                        });
                    });
                    
                    // Remove loading state
                    e.target.classList.remove('loading');
                }, 250);
            }
        });
    </script>

    <!-- Quote Generation Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Create Quote</h3>
                <button class="modal-close" onclick="closeModal('quoteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="quoteClientName">Full Name</label>
                                <input type="text" id="quoteClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="quoteClientPhone">Phone Number</label>
                                <input type="tel" id="quoteClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="quoteClientAddress">Address</label>
                                <input type="text" id="quoteClientAddress" required>
                            </div>
                            <div class="form-group">
                                <label for="quoteClientEmail">Email</label>
                                <input type="email" id="quoteClientEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="quoteDate">Quote Date</label>
                                <input type="date" id="quoteDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div class="service-items-container">
                            <div class="service-item" data-item-id="1">
                                <div class="item-row">
                                    <div class="item-description">
                                        <input type="text" class="item-desc-input" placeholder="Service description" value="">
                                    </div>
                                    <div class="item-quantity">
                                        <input type="number" class="item-qty-input" value="1" min="1">
                                    </div>
                                    <div class="item-price">
                                        <input type="number" class="item-price-input" value="" min="0" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="item-total">
                                        <span class="item-total-amount">$0.00</span>
                                    </div>
                                    <div class="item-actions">
                                        <button type="button" class="remove-item-btn" onclick="removeServiceItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addServiceItem()">
                            <i class="fas fa-plus"></i> Add Service Item
                        </button>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="taxToggle" onchange="toggleTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="taxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="grandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('quoteModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateQuote()">
                            <i class="fas fa-save"></i> Save Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Preview Modal -->
    <div id="quotePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Quote Saved Successfully</h3>
                <button class="modal-close" onclick="closeModal('quotePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="quotePreviewContent" class="quote-preview">
                    <!-- Quote content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('quotePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printQuote()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadQuotePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Generation Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content quote-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Create Invoice from Quote</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="quote-form">
                    <!-- Client Information Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-user"></i> Client Information</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="invoiceClientName">Full Name</label>
                                <input type="text" id="invoiceClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientPhone">Phone Number</label>
                                <input type="tel" id="invoiceClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientAddress">Address</label>
                                <input type="text" id="invoiceClientAddress" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceClientEmail">Email</label>
                                <input type="email" id="invoiceClientEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Service Items Section -->
                    <div class="quote-section">
                        <h4><i class="fas fa-tools"></i> Service Items</h4>
                        <div id="invoiceServiceItems" class="service-items-container">
                            <!-- Service items will be populated from quote -->
                        </div>
                    </div>

                    <!-- Tax and Total Section -->
                    <div class="quote-section">
                        <div class="tax-toggle-container">
                            <label class="tax-toggle-label">
                                <input type="checkbox" id="invoiceTaxToggle" onchange="toggleInvoiceTax()">
                                <span class="tax-toggle-text">Apply 5% Sales Tax</span>
                            </label>
                        </div>
                        <div class="quote-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="invoiceSubtotalAmount">$0.00</span>
                            </div>
                            <div class="total-row tax-row" id="invoiceTaxRow" style="display: none;">
                                <span>Tax (5%):</span>
                                <span id="invoiceTaxAmount">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="invoiceGrandTotalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Actions -->
                    <div class="quote-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn-primary" onclick="generateInvoice()">
                            <i class="fas fa-file-invoice"></i> Create Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal">
        <div class="modal-content quote-preview-content">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Invoice Created Successfully</h3>
                <button class="modal-close" onclick="closeModal('invoicePreviewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent" class="quote-preview">
                    <!-- Invoice content will be generated here -->
                </div>
                <div class="quote-preview-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('invoicePreviewModal')">
                        <i class="fas fa-check"></i> Done
                    </button>
                    <button type="button" class="btn-primary" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn-success" onclick="downloadInvoicePDF()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 